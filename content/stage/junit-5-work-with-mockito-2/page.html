---
title: JUnit 5 使用 Mockito 2 进行测试
url: /junit-5-work-with-mockito-2/
date: 2018-05-13T17:11:57-05:00
featured: false
draft: false
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/https://unmi.cc/wp-content/uploads/2017/09/junit5_logo.png"
categories:
  - Java/JEE
tags: 
  - mockito
  - JUnit5
comment: true
codeMaxLines: 50
# additional
wpPostId: 8291 
wpStatus: publish
views: 2671
lastmod: 2021-09-10T12:58:11-05:00
---

JUnit 5 刚出来那时，也就是第一个版本 5.0.0 时，还不能很好的支持 Mockito 的测试，因为 Mockito 没能跟得那么紧密。那时候 JUnit 5 只能试验性的提供了一个极不正式的 <a href="https://github.com/junit-team/junit5-samples/blob/master/junit5-mockito-extension/src/main/java/com/example/mockito/MockitoExtension.java">com.example.mockito.MockitoExtension</a>, 看那包名就知道不是来真的，所以决定再等。JUnit 5 不再原生支持 JUnit 4 的 Rule，一切都将是 Extension，那也是要求 Mockito 能够与之俱进。现在等来了，JUnit 5 进化到了 5.2.0, Mockito 也早已有了一个单独的模块 <code>mockito-junit-jupiter</code> 来迎接它。</p>
<br/>
在 Mockito 2.1.0 的 <a href="https://github.com/mockito/mockito/wiki/What%27s-new-in-Mockito-2#improvements">What's new in Mockito 2</a> 中记述了 JUnit 5 为 Mockito 2 开发了一个 MockitoExtension。追溯到 Mockito 2 的 Release Notes, 我们发现 Mockito 2 官方最早引入 MockitoExtension 的版本是 2.16.3(2018-03023)。我对 Mockito 对 JUnit 5 支持的最新更新是从这个 Pull Request <a href="https://github.com/mockito/mockito/pull/1221">MockitoExtension for JUnit5</a> 得知的。<br/><br/>
一句话讲就是现在的 Mockito 2 有原生态的 MockitoExtension 来支援 JUnit 5, 可以非常放心可靠的让 JUnit 5 和 Mockito 2 一起稳定工作。因此前面那个包名带 <code>example</code> 字样的 MockitoExtension 链接也就无效了。<!--more--><br/><br/>
下面来体验一下那个 MockioExtension，测试当中需要的依赖包含 <code>junit-jupiter-engine</code> 和 <code>mockito-junit-jupiter</code><br/><br/>
<pre class="lang:default decode:true">&lt;dependency&gt;
    &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
    &lt;artifactId&gt;junit-jupiter-engine&lt;/artifactId&gt;
    &lt;version&gt;5.2.0&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.mockito&lt;/groupId&gt;
    &lt;artifactId&gt;mockito-junit-jupiter&lt;/artifactId&gt;
    &lt;version&gt;2.18.3&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</pre>
<br/>
都取了当前在 Maven 中央仓库的最新版本。<br/><br/>
在 IntelliJ IDEA 2018.1.3 版本中运行接下来的测试用例，连 <code>jnit-jupiter-engine</code> 都可以不要，看来 IntelliJ IDEA 自带了 jupiter-api 实现。Maven 命令可不行，而且 Maven 还要插件依赖 <code>junit-platform-surefire-provider</code> 才能执行。<br/><br/>
首先我们要有一个被测试类 UserService<br/><br/>
<pre class="lang:default decode:true ">public class UserService {
    private List&lt;String&gt; users;<br/><br/>
    public UserService(List&lt;String&gt; users) {
       this.users = users;
    }<br/><br/>
    public void addUser(String name) {
        users.add(name);
    }
}</pre>
<br/>
然后创建它的测试用例 UserServiceTest<br/><br/>
<pre class="lang:default decode:true ">package cc.unmi;<br/><br/>
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;<br/><br/>
import java.util.List;<br/><br/>
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;<br/><br/>
@ExtendWith(MockitoExtension.class)
public class UserServiceTest {<br/><br/>
    @Mock
    private List&lt;String&gt; users;<br/><br/>
    @InjectMocks
    private UserService userService;<br/><br/>
    @Test
    @DisplayName("Should add a user to list")
    public void shouldAddUserToList() {
        userService.addUser("hello");<br/><br/>
        verify(users, times(1)).add("hello");
    }
}</pre>
<br/>
JUnit 5 下只能用 <code>@ExtendWith</code>, 找不到 <code>@RunWith</code> 了，虽然 <code>MockitoJUnitRunner</code> 还在，可它是为 JUnit 4 准备的。<br/><br/>
在 IntelliJ IDEA 中运行该测试<br/><br/>
<a href="/wp-content/uploads/2018/05/junit5-mockito2-1.png"><img class="aligncenter size-full wp-image-8710" src="/wp-content/uploads/2018/05/junit5-mockito2-1.png" alt="" width="528" height="123" /></a><br/><br/>
一切工作正常，方法被 Mock, Mock 对象自动被注入，<code>@DisplayName</code> 也正常显示<br/><br/>
若要用 <code>mvn test</code> 在控制台下运行测试用例，还要为 <code>maven-surefire-plugin</code> 加上一个内部依赖，在 <code>pom.xml</code> 文件中<br/><br/>
<pre class="lang:default decode:true">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.21.0&lt;/version&gt;
            &lt;dependencies&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
                    &lt;artifactId&gt;junit-platform-surefire-provider&lt;/artifactId&gt;
                    &lt;version&gt;1.2.0&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</pre>
<br/>
然后执行控制台命令<br/><br/>
<blockquote>
$ mvn test
</blockquote>
<br/>
<a href="/wp-content/uploads/2018/05/junit5-mockito2-2.png"><img class="aligncenter size-full wp-image-8711" src="/wp-content/uploads/2018/05/junit5-mockito2-2.png" alt="" width="717" height="233" /></a><br/><br/>
控制台下仍然是不会显示 <code>@DisplayName</code> 指定的描述。<br/><br/>
至此为 JUnit 5 与 Mockito 2 工作扫清了一个障碍。可是刚刚偶然间用 Java 10 跑了一下 <code>mvn test</code> 来运行这个例子，出问题了，Java 8, 9 相继被 Oracle 放弃了，离 Java 10 真会越来越远了。
