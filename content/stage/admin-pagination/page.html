---
title: 自定义 WordPress 插件如何对记录进行分页
url: /admin-pagination/
date: 2010-07-05T02:56:00-05:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
categories:
  - WordPress
tags: 
  - wordpress
  - pagination
comment: true
codeMaxLines: 50
# additional
wpPostId: 162 
wpStatus: publish
views: 336
lastmod: 2021-09-03T20:26:35-05:00
---

在我们为 WordPress 开发插件的时候，在涉及到列表显示许多记录的时候，肯定要考虑分页显示的问题。自然的，不管是简单性也好，还是统一性，直接参考下 WordPress 自己是怎么实现的，看看 Posts 或 User 管理页面的实现代码，比如 User 管理页面的实现代码在 wp-admin/includes/user.php 中的 WP_User_Search 类。默认实现其实是很好看的，如：<img src="/wp-content/uploads/2010/07/wordpress-post-paging.png" alt="" />。那我们如何在自己的插件里实现这样的效果呢，比如像这个： <!--more--></p>
<br/>
<div><img src="/wp-content/uploads/2010/07/wordpress-paging.png" alt="" /></div>
<br/>
我的做法是新建了自己的一个 Pagination 类，My_Pagination 类的内容如下：<br/><br/>
<pre class="lang:default decode:true ">&lt;?php
/**
 * Used for show paged records
 * @author Unmi
 */
class FN_Pagination {<br/><br/>
    /**
     * data to display
     */
    var $results;<br/><br/>
    /**
     * Page number.
     * @var int
     */
    var $current_page_number;<br/><br/>
    /**
     * Amount of records to display per page.
     * @access public
     * @var int
     */
    var $records_per_page = 20;<br/><br/>
    /**
     * @var int
     */
    var $total_record_count = 1;<br/><br/>
    /**
     * @access private
     * @var string
     */
    var $paging_text;<br/><br/>
    /**
     * @var string
     */
    var $base_page_url;<br/><br/>
    /**
     * PHP4 Constructor - Sets up the object properties.
     * @param string $prepare_sql_str 一个不带 LIMIT 的 sql 语句
     * @param string $base_page_url 分页跳转时的 URL，用于生成分页的 URL
     * @param string $current_page_number 当前页号，从请求中可取得
     * @param int $records_per_page 每页记录数
     * @return FN_Pagination
     */
    function FN_Pagination ($prepare_sql_str,$base_page_url, $current_page_number = '',$records_per_page=20) {
        $this-&gt;base_page_url = $base_page_url;
        $this-&gt;current_page_number = (int) ( '' == $current_page_number ) ? 1 : $current_page_number;
        $this-&gt;records_per_page = $records_per_page;
        $this-&gt;query($prepare_sql_str);
        $this-&gt;do_paging();
    }<br/><br/>
    /**
     *
     * @access public
     */
    function query($prepare_sql_str) {
        global $wpdb;<br/><br/>
        $get_count_sql = preg_replace("/SELECT.+?FROM/is","SELECT count('c') FROM",$prepare_sql_str,1);<br/><br/>
        //if sql string contains group by
        if(preg_match("/group.+?by/is", $get_count_sql) &gt;0 ) {
            //$this-&gt;total_record_count = count($wpdb-&gt;get_col($wpdb-&gt;prepare($get_count_sql)));
            $this-&gt;total_record_count = $wpdb-&gt;get_var(
                $wpdb-&gt;prepare("select count('c') from (($get_count_sql) as a)"));
        }else{
            $this-&gt;total_record_count = $wpdb-&gt;get_var($wpdb-&gt;prepare($get_count_sql));
        }<br/><br/>
        //or
        //$this-&gt;total_record_count = $wpdb-&gt;get_var(
        //  $wpdb-&gt;prepare("select count('c') from (($get_count_sql) as a)"));<br/><br/>
        $start_record = ($this-&gt;current_page_number-1) * $this-&gt;records_per_page;
        //此方面前面部分只是为了获得记录总数，分了带不带 group by 的情况<br/><br/>
        $this-&gt;results = $wpdb-&gt;get_results($wpdb-&gt;prepare($prepare_sql_str. " LIMIT $start_record,$this-&gt;records_per_page"));
    }<br/><br/>
    /**
     *
     * @since unknown
     * @access public
     */
    function do_paging() {<br/><br/>
        if ( $this-&gt;total_record_count &gt; $this-&gt;records_per_page ) { // have to page the results<br/><br/>
            //调用了 wp-includes/general-template.php 中的 paginate_links() 方法用于产生用于页面显示的导航链接
            $this-&gt;paging_text = paginate_links( array(
                'total' =&gt; ceil($this-&gt;total_record_count / $this-&gt;records_per_page),
                'current' =&gt; $this-&gt;current_page_number,
                'base' =&gt; $this-&gt;base_page_url . '&amp;%_%',
                'format' =&gt; 'page_no=%#%'
            ) );<br/><br/>
            //理解一下用的占位符，通过 format 和 base，会生成像如下的链接，注意何时 ?%_%，何时&amp;%_%
            // http://unmi/wp-admin/admin.php?page=my_plugin/tracking-logs.php&amp;page_no=2 <br/><br/>
            if ( $this-&gt;paging_text ) {
                $this-&gt;paging_text = sprintf( '&lt;span class="displaying-num"&gt;' . __( 'Displaying %s–%s of %s' ) . '&lt;/span&gt;%s',
                    number_format_i18n( ( $this-&gt;current_page_number - 1 ) * $this-&gt;records_per_page + 1 ),
                    number_format_i18n( min( $this-&gt;current_page_number * $this-&gt;records_per_page, $this-&gt;total_record_count ) ),
                    number_format_i18n( $this-&gt;total_record_count ),
                    $this-&gt;paging_text
                );
            }
        }
    }<br/><br/>
    /**
     * @access public
     */
    function get_results() {
        return (array) $this-&gt;results;
    }<br/><br/>
    /**
     * Displaying paging text.
     * @access public
     */
    function page_links() {
        echo $this-&gt;paging_text;
    }<br/><br/>
    /**
     * Whether paging is enabled.
     * @see do_paging() Builds paging text.
     * @access public
     * @return bool
     */
    function results_are_paged() {
        if ( $this-&gt;paging_text )
            return true;
        return false;
    }
}
?&gt;</pre>
<br/>
使用时，当然先要引入上面那个文件了，然后通过下面的代码取得当页要显示的记录集，同时也得到了你要的分页连接：<br/><br/>
<pre class="lang:default decode:true ">&lt;?php
@$page_no = $_GET['page_no'];<br/><br/>
$sql = "你的 sql 语句，可以复杂点的";<br/><br/>
$pagination = new FN_Pagination($sql,'admin.php?page=my_plugin/tracking-logs.php',$page_no);
$records = $pagination-&gt;get_results();<br/><br/>
//然后列表循环显示你的 $records 记录
?&gt;<br/><br/>
&lt;?php /** 然后在你想要放置翻页链接的地方加上下面的代码，注意 &lt;div&gt; 层次，以运用正确的样式**/?&gt;
&lt;div class="tablenav"&gt;
    &lt;?php if ( $pagination-&gt;results_are_paged() ) : ?&gt;
        &lt;div class="tablenav-pages"&gt;&lt;?php $pagination-&gt;page_links(); ?&gt;&lt;/div&gt;
    &lt;?php endif; ?&gt;
&lt;/div&gt;</pre>
<br/>
就这样，整个过程就完成了，看看页面是不是你想要的结果。上面的分页类暂时未加入条件搜索和排序的支持，以后还得进一步扩充的。
