---
title: Unmi 的 Struts2 学习笔记(七)
url: /unmi-study-struts2-7/
date: 2008-03-29T14:52:00-05:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/https://yanbin.blog/wp-content/uploads/2007/05/struts-logo.jpeg"
categories:
  - Struts
tags: 
  - Struts2
comment: true
codeMaxLines: 50
# additional
wpPostId: 424 
wpStatus: publish
views: 364
lastmod: 2021-05-02T23:58:35-05:00
---

小时候，大人们的谆谆教诲：做人要诚实。并真以此为做人原则。长大后才知道何谓社会。譬如530，再如艳照门，风声乍起之时，有人辟谣；直东窗事发后，道貌岸然者有之、恬不知耻者亦有之。原本成功就不属于规矩之人。纵观，无玄武门之血腥，何来一代宗皇；老毛若不有理而造反，一味守规矩，或为一介书匠耳。雅各一碗红豆汤便谋得以扫的长子权，再行骗去亚伯拉罕的祝福，并顺理成章让耶和华与他同在，可见上帝之“贤明”？。高等教育中有一句，顺利的是骗子，倒霉的是傻子，我是？不还有企业家的原罪吗？有时竟被社会所放任？<br/><br/>
1. 前面讲的自定义类型转换器是基于 OGNL 的 DefaultTypeConverter 类并实现 convertValue() 方法，两个转换方向的逻辑都写在这一个方法中。而 Struts 2 为我们提供了一个 DefaultTypeConverter 的抽象子类 StrutsTypeConverter 来继承，并实现其中两个抽象方法 convertFromString() 和 convertToString()，这要简单易懂。对比 Struts 1 的转换器是要实现 org.apache.commons.beanutils.Converter 接口，以及它的 convert() 方法的。<!--more--><br/><br/>
2. 注意，上面的 convertFromString() 的第二个参数是一个字符串数组，所以可为请求的数组(如请求串为 ?u=1&amp;u=2&amp;u=3)定义转换器，Action 中相应的属性就应为数组或 List，这一方法的返回值也该为相应的类型(数组或List，要通过第三个参数 toClass 来判断是返回数组还是 List 了)。<br/><br/>
3. 字符串(如 "user,pass") 转换成 Action 中的复合属性(如 User user) 前面是自定了类型转换器。除此之外，还可以 Struts 2 内置的 OGNL 表达式，更简单的转换，不用写转换器。例如，你的 Action 有属性 User user，只要在 jsp 页面的输入框命名为 user.name  和 user.pass 即可：<br />
        &lt;input type="text" name="user.name"/&gt; 或用标签：&lt;s:textfield name="user.name" label="用户名"/&gt;<br />
        &lt;input type="text" name="user.pass"/&gt;  或用标签：&lt;s:textfield name="user.pass" label="密　码"/&gt;<br />
    提交后，Struts 2 即会帮你构造 User 对象(user = new User())，并赋上属性值(user.setName()，user.setPass())，最后 user 对象赋给 Action (xxxAction.setUser(user))。所以要明白有三个必备的东西：<br />
        1) User 要用一个默认构造方法 2) User 要有对应 name 和 pass 的设置方法 setName() 和 setPass() 3) Action 要有 user 属性的设置方法 setUser()，getUser() 也是要的，至于功用后面能看到。<br />
其实在 Struts 1 中也有这种用法，不过那是在 BeanUtils 中实现的。<br/><br/>
4. 如果 Action 中的属性是 <span style="color: #800080;">Map&lt;String, User&gt; users;</span> 那么与此对应的表单写法就是：(用标签来写)<br />
        &lt;s:textfield name="users['one'].name" label="第一个用户名"/&gt;<br />
        &lt;s:textfield name="users['one'].name" label="第一个密码"/&gt;<br />
        &lt;s:textfield name="users['two'].name" label="第二个用户名"/&gt;<br />
        &lt;s:textfield name="users['two'].name" label="第二个密码"/&gt;<br />
    应该不难想像，这个表单提交后，users  中存储的是什么吧!<br />
    如果是对于 Action 中的  List 属性，<span style="color: #800080;">List&lt;User&gt; users;</span> 那么与此对应的表单写法就是：<br />
        &lt;s:textfield name="users[0].name" label="第一个用户名"/&gt;<br />
        &lt;s:textfield name="users[0].name" label="第一个密码"/&gt;<br />
        &lt;s:textfield name="users[1].name" label="第二个用户名"/&gt;<br />
        &lt;s:textfield name="users[1].name" label="第二个密码"/&gt;<br/><br/>
5. 归纳前面3、4、5 几点，Struts2 的 Action 在设置每一个属性时都会 get 一下相应的元素 getUser() 或 getUsers()。<br />
    对于 3，在设置 user.name 和 user.pass 之前都会 getUser() 来获取 user 属性，如果 user 为 null 就构造 User 对象，然后设置相应的值。假如声明的时候就已构造好 User 对象，如有其他属性如 age=18，并不会被覆盖。 <br />
   对于 4 和 5，也是在设置每一个属性前都会调用 getUsers() 判断声明的 Map 或 List 是否为 null，是则构造对应的 HashMap 或  ArrayList() 对象；接着根据 Key 或下标去获取相应位置的元素，如果不存在或为 null 则构造之，然后设置相应属性值。由此可见，若某元素的某个属性未重设值则保留原值，若原来Map或List 已有多个元素，也只会改变到 Key 或索引所对应元素的某个属性。对于 List 有可能出现跳空的情况，如页面只有索引不从 0 开始<br />
         &lt;s:textfield name="users[1].name" label="第二个用户名"/&gt;<br />
        &lt;s:textfield name="users[1].name" label="第二个密码"/&gt;<br />
提交后就会发现，List 属性 users 的第一个元素为 null 了。同时如果尝试一下，你就会发现这里的 List 不能替代为数组 User[] users。 <br />
    这种样法，可在 Struts 1 中实现，但要略施些小节，见我的另一篇日志：<a href="http://unmi.cc/multi-lines-struts-actionform-list/">提交多行数据到Struts的ActionForm的List属性中</a> ，行为表现完全一致，只是换到 Struts 2 中一切都不用自己操心。<br/><br/>
6. 看第四点，Action 之所以知道该构造什么类型的元素完全是由泛型告诉它的。如果不用泛型(比如用的是 JDK1.4)，Action 中仅仅声明的是 Map users; 或 List users; Action 该如何处理呢？它也不知道，只能够帮你构造出无类型的 HashMap 和 ArrayList()，填充不了元素。这就必须在局部类型转换的配置文件中来指定集合元素的类型。例如 Action 为 LoginAction，就要在 LoginAction-conversion.properties 中声明了，格式如下：<br/><br/>
    #Element_xxx=复合类型，基中 Element 是固定的，xxx 为属性名<br />
    #下面表示为 List 属性 users 的元素为 com.unmi.vo.User 类型<br />
     Element_users=com.unmi.vo.User<br/><br/>
    对于 Map，须分别指定 Key 的类型和 Value 的类型<br />
    #Key_xxx=复合类型，基中 Key 是固定的，xxx 为 map 属性名，下面写成 String 都不行的<br />
    Key_users=java.lang.String<br />
    指定 Map 的 Value 的类型与指定 List 元素类型是一样的<br />
    Element_users=com.unmi.vo.User<br/><br/>
难怪 Struts 2 要与 1.5 以上 JDK  使用，泛型比配置来得方便。如果硬要用 1.4 JDK，就只有配置类型了，会多很多 conversion 文件的。在 <a href="http://unmi.cc/multi-lines-struts-actionform-list/">提交多行数据到Struts的ActionForm的List属性中</a> 中类型的确定由 AutoArrayList() 的构造参数完成。<br/><br/>
7. Set 是无序集合，所以无法像 List 那样用数字下标来访问，幸好 Struts 2 可为其指定索引属性。例如，LoginAction 声明为 Set users; (这里好像用泛型只能省得了 Element_users 说明，KeyProperty_users 少不了)。则需在 LoginAction-conversion.properties 中写下：<br />
    #指定 Set 的元素类型<br />
    Element_users=com.unmi.vo.User<br/><br/>
    #KeyProperty_集合属性名=集合元素的索引属性名，这里为 User 的 name 属性<br />
    KeyProperty_users=name<br/><br/>
此时提交页面这么写，最好提交前能根据输入的用户名自动修动输入框的 name。<br />
        用户名: &lt;input name="users('scott').name"/&gt;<br />
        密　码: &lt;input name="users('scott').pass"/&gt;<br />
显示的时候页面可用标签<br />
        用户名: &lt;s:property value="users('scott').name"/&gt;<br />
        密　码: &lt;s:property value="users('scott').pass"/&gt;<br />
注意前面，访问 Set 元素是用的圆括号，而不同于 Map、List、数组是用中括号。我想一般也犯不着非要用 Set 而不用 List，Struts 2 中用 Set 比在 Struts 1 中似乎还麻烦。<br/><br/>
8. Struts 2 内建了一批转换器：boolean、char、int、long、float、double 和它们的包装类型；Date，日期格式使用请求所在 Locale 的 SHORT 格式；数组，默认元素为字符串，<em>其他类型则要转换每一个元素?(好像是一次性转换完成的)</em>；集合，默认元素为字符串 XWorkList(String.class, Object[])，其他如 List&lt;Integer&gt; ids，类型为 XWorkList(Integer.class, Object[])，XWorkList 继承自 ArrayList。<br/><br/>
9. 类型转换出错由 Struts 来帮你处理，在默认拦截器栈中提供了 conversionError 拦截器，不用你写一点代码逻辑。conversionError 在出错时将错误封装成 fieldError，并放在 ActionContext 中。你所要做的就是遵循它的规则，1) 你的 Action 要继承自 ActionSupport，2)在 struts.xml 中声明名为 "input" 的 result，出错时会在 input 逻辑视图显示信息。3)尽量用标签来写输入域(如&lt;s:textfield name="number" label="数量"/&gt;)，这样转换出错后，就会像校验失败一样把错误信息显示在每个输入框上面(视模板而定)，否则要手工用 <span style="color: #800080;">&lt;s:fielderror/&gt;</span> 输出在某处。<br />
默认时输出错误信息为(比如是属性 number，输入的是字符串时)：<span class="errorMessage"><span style="color: #800080;">Invalid field value for field "number".</span><span style="color: #000000;">你可以改变默认显示，在全局国际化资源文件中加上 <span style="color: #800080;">xwork.default.invalid.fieldvalue={0}字段类型转换失败!</span>。在某些时候，可能还需要对特定字段指定特别的提示信息，那么在名为 ActionName.properties 的局部资源文件中加上 <span style="color: #800080;">invalid.fieldvalue.属性名=提示信息</span> (如 <span style="color: #800080;">invalid.fieldvalue.number=数量格式错误</span>)</span></span><br/><br/>
<span class="errorMessage"><span style="color: #000000;"><span class="errorMessage"><span style="color: #000000;"><span class="errorMessage"><span style="color: #000000;">10. 最后是集合属性转换错误时的显示，对于页面中的同名输入框，有多个出错误，如果手工用 <span style="color: #800080;">&lt;s:fieldError/&gt;</span> 只会显示一条错误，但要是输入页是用标签(如&lt;s:textfield name="number" label="数量"/&gt;)，仍会在每一个出错的输入框上都提示。至此类型转换的内容也就完结了。</span></span></span></span></span></span><br/><br/>
&nbsp;<br/><br/>
&nbsp;<br/><br/>
<div id="xunlei_com_thunder_helper_plugin_d462f475-c18e-46be-bd10-327458d045bd"> </div>
