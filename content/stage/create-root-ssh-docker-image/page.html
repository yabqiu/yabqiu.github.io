---
title: 创建可直接用 root 用户 ssh 登陆的 Docker 镜像
url: /create-root-ssh-docker-image/
date: 2024-06-06T14:57:05-05:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/http://unmi.cc/wp-content/uploads/2014/05/homepage-docker-logo.png"
categories:
  - Docker
tags: 
  - SSH
  - Docker
  - Dockerfile
comment: true
codeMaxLines: 50
# additional
wpPostId: 13650 
wpStatus: publish
views: 471
lastmod: 2024-06-06T14:57:30-05:00
---

有时候我们在 Mac OS X  或 Windows 平台下需要开发以 Linux 为运行时的应用，IDE 或可直接使用 Docker 容器，或 SSH 远程连接。本地命令行下操作虽然可以用 <code>docker exec</code> 连接正在运行的容器，但 IDE 远程连接的话 SSH 总是一种较为通用的连接方式，所以我们希望做一个能进行 SSH 连接的 Docker 容器。因为是本地运行的 Docker，我们想直接用 root 连接，以获得在容器中最大的运行权限。下面以 ubuntu:2004 基础镜像为例，看如何安装启用 ssh 服务以及允许 root 连接。<br/><br/>
<h3>创建允许 root + 密码登陆的镜像</h3><br/><br/>
我们创建一个基本的 Dockerfile 文件，内容为<!--more--><br/><br/>
<pre class="lang:default decode:true">FROM ubuntu:20.04<br/><br/>
RUN apt-get update &amp;&amp; apt-get install -y openssh-server &amp;&amp; \
    mkdir /var/run/sshd &amp;&amp; \
    echo 'root:your_password' | chpasswd &amp;&amp; \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config<br/><br/>
CMD ["/usr/sbin/sshd", "-D"]
</pre>
<br/>
注：<br/><br/>
<ol>
    <li>mkdir /var/run/sshd: 在启动 /usr/sbin/sshd 需用到，否则无法启动</li>
    <li>sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config: 允许 root 用户登陆，安装 openssh-server 后，PermitRootLogin 行默认被注释掉了</li>
    <li>如果登陆验证有问题，在构建镜像时加上 <code>sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd</code> 试试</li>
</ol>
<br/>
构建镜像<br/><br/>
<blockquote>
$ docker build -t demo-ssh .
</blockquote>
<br/>
创建了一个 tag 为 demo-ssh:latest 的镜像<br/><br/>
启动容器<br/><br/>
<blockquote>
$ docker run -d -p 2022:22 demo-ssh<br />
895e8c689c44b806da82d87980a292f55fd316bbfcce2ac3a174d7710511f272
</blockquote>
<br/>
映射主机上的端口号 2022 容器的 22<br/><br/>
SSH 登陆<br/><br/>
<blockquote>
$ ssh root@localhost -p 2022
</blockquote>
<br/>
由于使用了非默认的 22 端口号，所以需加上 <code>-p 2022</code> 指定连接端口号。<br/><br/>
第一次登陆会提示 Are you sure you want to continue connecting (yes/no/[fingerprint])?<br/><br/>
回答 yes 后，再输入前面构建镜像时的密码(your_password)就登陆成功了。<br/><br/>
就是下面的过程<br/><br/>
<pre class="lang:default decode:true ">The authenticity of host '[localhost]:2022 ([::1]:2022)' can't be established.
ED25519 key fingerprint is SHA256:PPAA8h/AKQS9n0myXjWn32i2Sr6d9bX+fZ9IynavXNg.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[localhost]:2022' (ED25519) to the list of known hosts.
root@localhost's password:
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 6.6.26-linuxkit x86_64)<br/><br/>
 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro<br/><br/>
This system has been minimized by removing packages and content that are
not required on a system that users do not log into.<br/><br/>
To restore this content, you can run the 'unminimize' command.<br/><br/>
The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.<br/><br/>
Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.<br/><br/>
root@895e8c689c44:~#</pre>
<br/>
fingerprint 记录在了本地的 ~/.ssh/known_hosts 文件中。如修改了镜像(重新构建了镜像)，还是在相同的映射端口上启动容器后，比如重新构建了 demo-ssh 镜像，停掉了原来的容器，再次用<br/><br/>
<blockquote>
$ docker run -d p 2022:22 demo-ssh
</blockquote>
<br/>
在相同的 2022 端口上映射容器内的 22 端口号<br/><br/>
<blockquote>
$ ssh root@localhost -p 2022
</blockquote>
<br/>
将会看到如下的信息<br/><br/>
<pre class="lang:default decode:true">ssh root@localhost -p 2022
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ED25519 key sent by the remote host is
SHA256:hKgsTk2QbpGoA3SS3qPGfbWKLZe3F5yTaYTBI4zBCck.
Please contact your system administrator.
Add correct host key in /Users/yanbin/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /Users/yanbin/.ssh/known_hosts:38
Host key for [localhost]:2022 has changed and you have requested strict checking.
Host key verification failed.</pre>
<br/>
我们需要在 ~/.ssh/known_hosts 中把 [localhost]:2022 行删除掉才能重新回答 <code>yes</code> 来用密码登陆。<br/><br/>
相同的镜像多次启动，或是用不同的映射端口启动容器都用不着从 ~/.ssh/known_hosts 中删除相应的条目。<br/><br/>
<h3>创建免密登陆的镜像</h3><br/><br/>
如果镜像不欲分享，那么参考 <a href="https://yanbin.blog/ssh-no-need-input-password/">如何无需密码进行 SSH 连接[翻译]</a>，我们可以创建一个不用输入密码就能 SSH 登陆的 Docker 镜像。<br/><br/>
首先在本地用 <code>ssh-keygen -t rsa</code> 在目录 ~/.ssh 下生成 id_rsa 和 id_rds.pub 密钥文件，记住在询问 <code>Enter passphrase</code> 是直接回车过掉。<br/><br/>
然后在构建 Docker 镜像是把本地的 <code>~/.ssh/id_rsa.pub</code> 的内容放到镜像的 <code>/root/.ssh/authorized_keys</code> 文件中。<br/><br/>
相应的 Dockerfile 是<br/><br/>
<pre class="lang:default decode:true">FROM ubuntu:20.04<br/><br/>
ARG ssh_pub_key<br/><br/>
RUN apt-get update &amp;&amp; apt-get install -y openssh-server &amp;&amp; \
    mkdir /var/run/sshd &amp;&amp; \ 
    mkdir /root/.ssh &amp;&amp; \
    echo "$ssh_pub_key" &gt; /root/.ssh/authorized_keys<br/><br/>
CMD ["/usr/sbin/sshd", "-D"]
</pre>
<br/>
由于无需用户/密码登陆，所以关于启于 root 用户登陆相关的内容也用不着了。<br/><br/>
构建命令<br/><br/>
<blockquote>
$ docker build -t demo-ssh --build-arg ssh_pub_key="$(cat ~/.ssh/id_rsa.pub)" .
</blockquote>
<br/>
这样本地的 ~/.ssh/id_rsa.pub 文件内容就会跑到镜像的 /root/.ssh/authorized_keys 中去<br/><br/>
同样的方式启动容器，但 SSH 连接容器时不用输入密码了<br/><br/>
<blockquote>
$ ssh root@localhost -p 2022
</blockquote>
<br/>
~/.ssh/known_hosts 的处理方式会是一样的，现在不需要输入密码就能登陆了。<br/><br/>
另外还能配置默认的用户和端口号，在 ~/.ssh/config 文件中<br/><br/>
<pre class="lang:default decode:true ">Host localhost
  User root
  Port 2022
</pre>
<br/>
这样的话，输入<br/><br/>
<blockquote>
$ ssh localhost
</blockquote>
<br/>
就相当于下面的全命令<br/><br/>
<blockquote>
$ ssh root@localhost -p 2022
</blockquote>
<br/>
而且配置了 ssh key 的话，ssh localhost 就直接登陆了。<br/><br/>
<pre class="lang:default decode:true ">$ ssh localhost
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 6.6.26-linuxkit x86_64)<br/><br/>
 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro<br/><br/>
This system has been minimized by removing packages and content that are
not required on a system that users do not log into.<br/><br/>
To restore this content, you can run the 'unminimize' command.
Last login: Wed Jun  5 20:32:05 2024 from 192.168.65.1
root@0474baf1a1ff:~#</pre>
<br/>
只有第一次必须回答 yes 接受 fingerprint, 以后只需像上面那样输入 <code>ssh localhost</code> 就非常顺滑进入到容器的终端。<br/><br/>
用 scp 命令在本地和 SSH 主机上搬运文件和 ssh 的验证方式是一样的，比如拷贝一个文件进到容器可以用命令<br/><br/>
<blockquote>
$ scp test.txt localhost:/
</blockquote>
<br/>
因为是 Docker 容器，大可不必用 scp, 用 docker cp 就行，不依赖于 ssh, 只要写上可定位唯一容器的 ID 前缀<br/><br/>
<blockquote>
$ docker cp test.txt 89:/
</blockquote>
