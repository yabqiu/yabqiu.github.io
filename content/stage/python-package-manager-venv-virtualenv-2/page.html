---
title: "Python 包管理及虚拟环境的应用(二: virtualenv)"
url: /python-package-manager-venv-virtualenv-2/
date: 2019-01-03T01:16:13-06:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/http://unmi.cc/wp-content/uploads/2016/06/python-icon-200x200.png"
categories:
  - Python
tags: 
  - virtualenv
  - venv
  - pipenv
  - pyvenv
comment: true
codeMaxLines: 50
# additional
wpPostId: 9212 
wpStatus: publish
views: 475
lastmod: 2020-07-31T02:31:38-05:00
---

原本想在一篇之内覆盖到 Python 的包管理以及各类虚拟环境的应用，没想根本就是一发不可收拾，恐怕两篇都完不了，所以也要进行重构。这里只涉及到 Python 的虚拟环境 <code>venv</code> 和 <code>virtualenv</code>，至于标题的话，也不想再改了，只作一，二，三编号，必要时仍能连缀成长篇。最后一篇将单独学习 <code>pipenv</code> 的应用。</p>
<br/>
以下序号也是承接上一篇 <a href="https://wp.me/p11aRw-2od">Python 包管理及虚拟环境的应用(一)</a>。<br/><br/>
<h2>2. Python 虚拟环境</h2><br/><br/>
关于创建 Python 项目的虚拟环境，有三个工具可用, <code>venv</code>, <code>virtualenv</code>, 以及后面单独要学到的 <code>pipenv</code><br/><br/>
<ol>
    <li><a href="https://docs.python.org/3/library/venv.html"><code>venv</code></a> , 即 <code>python3 -m venv</code> 命令，Python 3.3 及新版本自带了，为 Python 3.4 及以后的版本创建的虚拟环境会有 <code>pip</code> 和 <code>setuptools</code> 命令</li>
    <li><code>virtualenv</code> 需要单独安装，但是它支持 Python 2.7 和  Python 3.3+， 创建的虚拟环境中带有 <code>pip</code>, <code>setuptools</code> 和 <code>wheel</code> 命令</li>
    <li>另外，<code>pyvenv</code> 脚本也可用来创建 Python 虚拟环境，不过它自 Python 3.6 不推荐使用，建议用 <code>python3 -m venv</code> 命令</li>
</ol>
<br/>
<!--more--><br/><br/>
从以上几点来理解，<code>virtualenv</code> 可用于兼容 Python 2 和 3，如果只用到 Python 3.3 及以后的版本的话，推荐使用 <code>python3 -m venv</code>，实质上它们两都没多大的区别。下面分别看下 <code>venv</code> 和 <code>virtualenv</code> 的应用<br/><br/>
<h3>2.1 venv(python3 -m venv)</h3><br/><br/>
<code>venv</code> 是以一个标准的 Python 模块来执行的，由于它在 Python 3.3+ 中自带了，所以不用安装。<code>python3 -m venv</code> 或 <code>python3 -m venv -h</code> 可以看到使用帮助，然后实际用来创建一个虚拟环境时，比如以下命令<br/><br/>
<blockquote>
python3 -m venv demo
</blockquote>
<br/>
可能就出现缺组件的提示，类似<br/><br/>
<blockquote>
vagrant@ubuntu-bionic:~$ python3 -m venv demo<br />
The virtual environment was not created successfully because ensurepip is not<br />
available. On Debian/Ubuntu systems, you need to install the python3-venv<br />
package using the following command.
apt-get install python3-venv
You may need to use sudo with that command. After installing the python3-venv<br />
package, recreate your virtual environment.
Failing command: ['/home/vagrant/demo/bin/python3', '-Im', 'ensurepip', '--upgrade', '--default-pip']
</blockquote>
<br/>
那么就要安装 <code>python3-venv</code><br/><br/>
<blockquote>
sudo apt-get install python3-venv
</blockquote>
<br/>
然后就能够<br/><br/>
<h5>2.1.1 创建虚拟环境项目</h5><br/><br/>
<blockquote>
python3 -m venv demo
</blockquote>
<br/>
创建 <code>demo</code> 项目，同时建立相应的  <code>demo</code> 目录，来了解一下该目录中有什么，见下图<br/><br/>
<a href="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-1.png"><img class="aligncenter size-full wp-image-9202" src="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-1.png" alt="" width="672" height="365" /></a><br/><br/>
<code>lib</code> 中的目录层次是 <code>lib/python3.6/site-packages/</code>。从 <code>bin</code> 目录中看到有  <code>pip</code> 和  <code>easy_install</code>。所以这个 <code>demo</code> 目录俨然一个完整的 Python 运行环境，因而谓之虚拟环境。<br/><br/>
<h5>2.1.2 激活虚拟环境</h5><br/><br/>
<blockquote>
source bin/activate
</blockquote>
<br/>
<a href="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-2.png"><img class="aligncenter size-full wp-image-9203" src="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-2.png" alt="" width="551" height="112" /></a><br/><br/>
<code>(demo)</code> 提示当前激活了虚拟环境。<code>bin/activate</code> 为 <code>bash</code> 或 <code>zsh</code> 配置了基本的环境，如<br/><br/>
<ol>
    <li>命令提示符前加 <code>(demo)</code>,</li>
    <li>把 <code>demo/bin</code> 放在 <code>PATH</code> 的最前面，确保 <code>pip</code>, <code>python</code> 等命令默认是 <code>demo/bin</code> 下的相应命令</li>
    <li>并创建 <code>deactivate</code> 函数用于退出虚拟环境</li>
</ol>
<br/>
<code>activate.csh</code> 和 <code>activate.fish</code> 分别是为 <code>csh</code> 和 <code>fish</code> 服务的。且其中的 <code>pip</code>, <code>pip3</code>, <code>pip3.6</code> 可能完全是一回事，<code>python</code> 和 <code>python3</code> 也是一样的。<br/><br/>
<h5>2.1.3 查看虚拟环境的 <code>sys.path</code></h5><br/><br/>
在激活了虚拟环境后，执行 <code>python3 -c "import sys; print(str(sys.path).replace(',', '\n'))"</code><br/><br/>
<pre class="lang:default mark:5 decode:true">[''
 '/usr/lib/python36.zip'
 '/usr/lib/python3.6'
 '/usr/lib/python3.6/lib-dynload'
 '/home/vagrant/demo/lib/python3.6/site-packages']</pre>
<br/>
<h5>2.1.4 测试虚拟环境</h5><br/><br/>
<blockquote>
pip install boto3
</blockquote>
<br/>
模块将安装到 <code>/home/vagrant/demo/lib/python3.6/site-packages</code> 中，根据前面的 <code>sys.path</code> 列表内容，<code>boto3</code> 可被该虚拟环境加载到。<br/><br/>
在使用虚拟环境时切记不要用以下两条命令之一来安装模块<br/><br/>
<blockquote>
sudo pip install  boto3   # 可能找不到 pip 命令<br />
pip install boto3 --user   # 加了 --user 参数模块会安装到 <code>/home/vagrant/.local/lib/python3.6/site-packages</code> 目录中，无法被虚拟环境加载到
</blockquote>
<br/>
这样安装的模块只对当前虚拟环境有效，既不影响当前用户，更不会污染到全局系统。<br/><br/>
<h5>2.1.5 生成 <code>requirements.txt</code> 文件</h5><br/><br/>
安装了第三方模块后，可用命令 <code>pip freeze</code> 梳理出所有安装的第三方模块<br/><br/>
<pre class="lang:default decode:true">(demo) vagrant@ubuntu-bionic:~/demo$ pip freeze &gt; requirements.txt
(demo) vagrant@ubuntu-bionic:~/demo$ cat requirements.txt 
boto3==1.9.71
botocore==1.12.71
docutils==0.14
jmespath==0.9.3
pkg-resources==0.0.0
python-dateutil==2.7.5
s3transfer==0.1.13
six==1.12.0
urllib3==1.24.1
</pre>
<br/>
由于安装了 <code>boto3</code> 时也安装了它所依赖了其他包，其实这个 <code>requirements.txt</code> 只需要一行<br/><br/>
<blockquote>
boto3==1.9.71
</blockquote>
<br/>
就行，<code>pip freeze</code> 还不足够聪明只抓出所以最顶层的依赖。版本控制服务器上只要分享 <code>requirements.txt</code> 就行，其他人拿到这个文件，只需要用<br/><br/>
<blockquote>
pip install -r requirements.txt
</blockquote>
<br/>
安装其他描述的所有依赖。关于 requirements.txt 文件的格式请参考: <a href="https://pip.pypa.io/en/latest/reference/pip_install/#requirements-file-format">Requirements File Formats</a>。<br/><br/>
<h5>2.1.6 退出虚拟环境</h5><br/><br/>
<blockquote>
deactivate
</blockquote>
<br/>
<a href="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-3.png"><img class="aligncenter size-full wp-image-9204" src="https://yanbin.blog/wp-content/uploads/2019/01/python-venv-3.png" alt="" width="444" height="38" /></a><br/><br/>
<h3>2.2 virtualenv 命令</h3><br/><br/>
如果是 Python 3.3 以前的版本，需要单独安装 <code>virtualenv</code> 程序(模块)。安装命令如下：<br/><br/>
<blockquote>
sudo apt-get install virtualenv<br />
或 pip install virtualenv<br />
或 pip3 install virtualenv
</blockquote>
<br/>
第一种方式安装的 <code>virtualenv</code> 即是程序又是一个 Python 模块，也就是说可以用 <code>virtualenv</code> 或 <code>python -m virtualenv</code> 两种方式来运行，但它只支持 Python 2<br/><br/>
第二第三种方式安装的 <code>virtualenv</code> 只是一个 Python 模块，只能以 <code>python -m virtualenv</code> 方式执行，或 <code>python3 -m virtualenv</code><br/><br/>
pip 安装的 virtualenv 创建的虚拟环境只支持 Python 2, pip3 安装的 virtualenv 创建的虚拟环境只支持 Python 3。如果创建 Python 2 的虚拟环境时系统中未安装 Python 2 会提示<br/><br/>
<blockquote>
<div>
<div>vagrant@ubuntu-bionic:~$ virtualenv</div>
<div><span style="color: #993366;">The path python2 (from --python=python2) does not exist</span></div>
<div>vagrant@ubuntu-bionic:~$ python -m virtualenv</div>
<div>The path python2 (from --python=python2) does not exist</div>
</div>
</blockquote>
<br/>
其他的用 <code>virtualenv</code> 创建虚拟环境，激活，使用，退出等与 <code>venv</code> 是一样的，不再累述了。<br/><br/>
<h3>2.3 关于 Python 虚拟环境</h3><br/><br/>
创建 Python 虚拟环境是为了依赖相互隔离，并不需要为每一个 Python 项目创建独立的虚拟环境，就像多个系统用户可以共享全局环境，多个项目可以共享同一用户环境一样，多个 Python 项目也能共享同一个虚拟环境。比如两个非常类似的项目，它们所依赖的模块是一样的，它们就能用同一个虚拟环境。<br/><br/>
如果虚拟环境就在项目目录中，那么其中包含的 <code>bin</code>, <code>include</code>, <code>lib</code> 目录在提交到版本控制系统上时就需要被忽略掉，例如用 <code>.gitignore</code> 文件来排除。此时应该用 <code>requirements.txt</code> 列出所有的依赖，并提交该文件到版本控制系统中去。这一点 <code>pipenv</code> 就更聪明一些了，它的虚拟环境目录与项目目录是分离的。<br/><br/>
<code>venv</code> 与 <code>virtualenv</code> 基本上可以算是同一个东西吧，只是 Python 3.3+ 放到了标准库中，之前的版本才要单独安装，也就是 <code>virtualenv</code>。如果要用到 Python 3.3 之前的版本及 Python 2.7, 就必须用 <code>virtualenv</code>, 基本上只需 Python 3.3+ 的情况下用标准库中的 <code>venv</code> 就行。
