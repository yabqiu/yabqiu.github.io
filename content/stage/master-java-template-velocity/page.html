---
title: 掌握一种Java模板技术 – Velocity
url: /master-java-template-velocity/
date: 2007-06-04T09:53:00-05:00
featured: false
draft: true
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/https://yanbin.blog/wp-content/uploads/2007/06/velocity-logo.png"
categories:
  - Java/JEE
tags: 
  - velocity
  - Java
comment: true
codeMaxLines: 50
# additional
wpPostId: 517 
wpStatus: publish
views: 1215
lastmod: 2019-11-13T21:55:53-06:00
---

原来的项目中基本都是用 JSP+Tag  来展示内容，有时也有 Jasper Report 做报表，报表也算是一种模板技术，只是有些重量级。看过 Spring 的书籍，都会对 Velocity 和 FreeMaker 有介绍，带动了我对先前看过的 *.vm 文件的研究提上了日程，了解之后，已觉相见恨晚。</p>
<br/>
下面讲利用 Velocity 怎么更好解决目前项目的一个简单问题：系统在进行支付了支付后，自己按设定的信息模板发送一条短信给责任人。信息模板是：<br/><br/>
<span style="color: #0000ff;">{单据责任人}：您的 {单据号} 号{单据类型}在 {操作日期} 日已支付</span> <!--more--><br/><br/>
原来的处理方式是在程序中拿到上面定义的模板一次又一次的把前面大括中内容（含大括号）replaceAll() 成实际数据。<br/><br/>
如果更多的这种信息模板，处理起来就是不断的重复着代码。<br/><br/>
下面介绍利用 Velocity 如何简练的处理上面的问题。Velocity 可在 <a href="http://velocity.apache.org/">http://velocity.apache.org/</a> 下载，下得 velocity-1.5.zip (提笔时版本是1.5)，其中有 velocity-1.5.jar和其和依赖包（lib目录中），例子中采用从类路径中加载模板，具体步骤如下：<br/><br/>
一：定义模板文件 helloVelocity.vm （要放在类路径下）<br/><br/>
<pre class="brush:jscript">## {单据责任人}：您的 {单据号} 号{单据类型}在 {操作日期} 日已支付
${owner}：您的 ${bill} 号${type}在 ${ date } 日已支付</pre>
<br/>
双井号"##"开始是 velocity 模板的注释，与 Velocity.INPUT_ENCODING 对应，要求 helloVelocity.vm 用 GBK 字符集保存，否则出乱码。<br/><br/>
二：加载模板，填充值，输出。 HelloVelocity.java 的代码如下<br/><br/>
<pre class="brush:java">package com.unmi.velocity;<br/><br/>
import java.io.*;
import java.text.*;
import java.util.*;<br/><br/>
import org.apache.velocity.*;
import org.apache.velocity.app.*;<br/><br/>
public class HelloVelocity {
    public static void main(String[] args) throws Exception {
        // 配置初始化参数
        Properties props = new Properties();
        props.setProperty(Velocity.INPUT_ENCODING, "GBK");
        props.setProperty(Velocity.RESOURCE_LOADER, "class");
        props.setProperty("class.resource.loader.class",
                        "org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader");<br/><br/>
        // 初始化并取得Velocity引擎
        VelocityEngine ve = new VelocityEngine(props);<br/><br/>
        // 取得velocity的模版
        Template template = ve.getTemplate("helloVelocity.vm");<br/><br/>
        // Template实例的获取方式也可以用下面两行代码
        // Velocity.init(props);
        // Template template = Velocity.getTemplate("helloVelocity.vm");<br/><br/>
        // 取得velocity的上下文context
        VelocityContext context = new VelocityContext();<br/><br/>
        // 把数据填入上下文
        context.put("owner", "Unmi");
        context.put("bill", "1000");
        context.put("type", "报销单");
        context.put("date", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
                .format(new Date()));<br/><br/>
        // 输出流,你可以自由控制输出到哪，String、File、Socket 等
        Writer writer = new PrintWriter(System.out);<br/><br/>
        // 转换输出
        template.merge(context, writer);
        writer.flush();
    }
}</pre>
<br/>
以上代码执行结果是在控制台下输出<br />
<span style="color: #0000ff;"><br />
</span><span style="color: #ff0000;">Unmi：您的 1000 号报销单在 2007-06-04 21:56:13 日已支付</span><br/><br/>
OK,代码应该可以说是十分清晰明了，加载模板-&gt;填充值-&gt;合并模板输出内容，这就是模板技术要做的事情。<br />
上面介绍的是用 ClasspathResourceLoader 方式加载模板，Velocity 还提供了其他几种 ResourceLoader: DataSourceResourceLoader, FileResourceLoader, JarResourceLoader, StringResourceLoader, URLResourceLoader。由名称我们就能知道它们是从哪加载模板，可在项目中灵活选用适合自己的 ResourceLoader（通过配置 Velocity 引擎的初始化参数）。<br/><br/>
Velocity 的默认配置在 velocity.jar 中的 org/apache/velocity/runtime/defaults/velocity.propertis，你可以修改这个文件以适于你的需求，这样就不需要对 VelocityEngine 配置初始化参数 Properties 了。<br/><br/>
当然，上面只是一个非常简单的例子，如果仅能完成如此之功能，肯定是用不广泛。所以 Velocity 还提供定义了一种称之为 VTL(Velocity Template Language) 的东西,支持 #if、#foreach、#set、#include、#parse、#macro 等语法能处理你更复杂的数据8028，详细语法参考 <a href="http://airport.javaeye.com/blog/23634">Velocity用户手册</a>。可以定义出你想要的功能更完善的模板。他可以作为一个 view 替代 jsp。当然一家定义的 VTL 着实给学习者增加了不少难度，但当你真正喜欢上了，这些都不成问题。<br/><br/>
有一个 Velocity Eclipse 插件，可设置 Updates Site 为 <a href="http://propsorter.sourceforge.net/veloeclipse">http://propsorter.sourceforge.net/veloeclipse</a> 进行下载或更新，方便在Eclipse 中编辑 vm 文件。<br/><br/>
你可以想想 Velocity 能为你轻松解决什么问题，如定义模板自动化生成代码，把我某个 Blog 上的所有日志依据模板生成一个 rss.xml 文件就能导入到别的博客中，与 Spring 结合使用。<a href="http://velocity.apache.org/">http://velocity.apache.org/</a> 上的 anakia/texen/velocity-tools 为 Velocity 扩展了更多的功能。<br/><br/>
参考与应用：<br />
    1. <a href="http://java.ccidnet.com/art/3739/20060419/512951_1.html">Java的模板引擎Velocity初体验</a><br />
    2. <a href="http://www.ibm.com/developerworks/cn/java/j-sr1.html">Struts 与 Velocity 的集成</a><br />
    3. <a href="http://airport.javaeye.com/blog/23634">Velocity用户手册</a><br />
    4. <a title="永久链接：模板：velocity和freemarker的比较" href="http://ahuaxuan.javaeye.com/blog/71430">模板：velocity和freemarker的比较</a><br />
    5. <a href="http://hiwzg.javaeye.com/category/6878?list=1">邮件发送功能的模板实现</a><br />
    6. <a href="/fastzch/archive/2006/04/12/40721.html">Velocity改造心得</a>
