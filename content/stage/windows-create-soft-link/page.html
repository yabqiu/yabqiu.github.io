---
title: Windows 下也能创建硬链接和符号(软)链接
url: /windows-create-soft-link/
date: 2007-11-25T11:04:00-06:00
featured: false
draft: true
type: post
toc: false
# menu: main
usePageBundles: true
categories:
  - Windows
tags: 
  - Window
  - Soft Link
comment: true
codeMaxLines: 50
# additional
wpPostId: 467 
wpStatus: publish
views: 479
lastmod: 2010-08-20T13:13:58-05:00
---

首先简单理解一下硬链接和符号(软)链接的区别(<span style="color: #800080;">此文中的符号链接和软链接指同一概念</span>)：<br/>
<br/>
硬连接指向的是节点(inode)，而软连接指向的是路径(path) 。<br/>
<br/>
最初的文件名与所有的硬链接地位是对等的，比如为文件 a 建立了硬链接 b、c、d。那么a、b、c、d之中只要有一个文件未删除，这个文件就可通未删除的名称访问的。你也可以认为每个文件都可认为至少有一个硬链接，就是说 a 也是一个硬链接。<br/>
<br/>
软链接特性上有些类似于快捷方式，比如为原文件 a 建立了软链接 b、c、d。删除b、c 或 d 访问到 a，但是只要删除了 a，软链接就不可用了。但是 windows 下的快捷方式只能在资源管理器中有用，它只是一个 lnk 文件，如果是一个目录的快捷方式，它是不能通过 cd 命令或路径进入。<!--more--><br/>
<br/>
硬链接文件有两个限制(Unix/Linux 和 Windows 也都如此)<br/>
<br/>
　　1、不允许给目录创建硬链接；<br/>
　　2、只有在同一文件系统中的文件之间才能创建链接。<br/>
<br/>
更详细区别请见：<a href="http://www.buaabbs.com/bbs/viewthread.php?tid=3183">硬链结和符号链接的区别</a> ，具体不多述，本文的内容关键在 Windows 下如何建立软硬链接。<br/>
<br/>
熟悉过 Unix/Linux 都应该知道，Unix/Linux 用 ln 建立硬链接，ln -s 建立软链接，那么 Windows 下是如何做到的呢？<br/>
<br/>
一： Windows 下创建硬链接，只能适用于 NTFS 文件系统。使用命令 <span style="color: #800080;">fsutil hardlink</span><br/>
<br/>
语法<br/>
<span style="color: #800080;">fsutil hardlink create NewFileName ExistingFileName</span><br/>
<br/>
参数<br/>
<span style="color: #800080;">create</span> 建立现有文件和新文件之间的 NTFS 硬链接。NTFS 硬链接与 POSIX 硬链接相似。<br/>
<br/>
<span style="color: #800080;">NewFileName</span> 指定要将创建硬链接的文件。<br/>
<br/>
<span style="color: #800080;">ExistingFileName</span> 指定要从中创建硬链接的文件。<br/>
<br/>
当然，如果你想在自己的程序里创建硬链接，那也是很容易的，只需要一个很简单的 API 函数:<br/>
<br/>
<span style="color: #800080;">BOOL CreateHardLink(<br/>
    LPCTSTR lpFileName,<br/>
    LPCTSTR lpExistingFileName,<br/>
    LPSECURITY_ATTRIBUTES lpSecurityAttributes<br/>
);</span><br/>
<br/>
适用于 Win2000 及以上版本的系统，前两个参数的意思就不用解释了，最后一个参数的用途暂时保留，必须为 NULL。<br/>
<br/>
二：Windows 下创建软链接，NTFS 只支持对目录的软链接，微软把它称作 junction。但是对于文件的软链接，微软也有提供解决方案，那就是快捷方式(Shortcut，.lnk 文件)。不过软链接和快捷方式不是一个层次上的东西，前者是底层文件系统的功能，后者是应用层的功能。Windows 下目录的快捷方式用 dir 看起来是个文件。<br/>
<br/>
在 <a href="http://www.microsoft.com/technet/sysinternals/FileAndDisk/Junction.mspx">http://www.microsoft.com/technet/sysinternals/FileAndDisk/Junction.mspx</a> 下载 junction.exe。junction 的命令语是：<br/>
<br/>
<span style="color: #800080;">junction  LinkDirectory ExistingDirectory<span style="color: #800080;"><font color="#800080"><span style="color: #000000;">例如：</span><br/>
<br/>
</font></span> <br/>
<br/>
</span><br/>
<br/>
<span style="color: #800080;">junction d:\link c:\winnt</span><br/>
<br/>
将为c:\winnt 建立一个链接目录 d:\link，C和D分区都要是 NTFS 格式，在资源管理器和 dir 列示中 d:\link 都以目录的面目存在的。d:\link 就像是 c:\winnt 的一个引用一般，删除 d:\link 目录中的内容也就是删除了 c:\winnt 中的内容，但删除 d:\link 本身是不会影响到 c:\winnt 的。<br/>
<br/>
相应的，在程序中也有一个 API 函数 CreateSymbolicLink 支持创建软链接，不过来得太晚了，要 Windows VISTA 和 Windows Server 2008 那样的版本才支持，先还是别想了，API 原型是：<br/>
<br/>
<span style="color: #800080;">BOOL WINAPI CreateSymbolicLink(<br/>
  __in  LPCWSTR lpSymlinkFileName,<br/>
  __in  LPCWSTR lpTargetFileName,<br/>
  __in  DWORD dwFlags<br/>
);</span><br/>
<br/>
参数：<br/>
<span style="color: #800080;">lpSymlinkFileName</span> 要创建的符号链接名称.<br/>
<br/>
<span style="color: #800080;">lpTargetFileName</span> 符号链接所对应目标的名称.<br/>
<br/>
<span style="color: #800080;">dwFlags</span> 标识目标是文件还是目录. 取值0x0 代表是文件，SYMBOLIC_LINK_FLAG_DIRECTORY或0x1 代表是目录<br/>
<br/>
三：其他方法<br/>
<br/>
也可以使用 <a href="http://unxutils.sourceforge.net/">GNU utilities for Win32</a> 中的 ln 来创建硬链接。这是一些 GNU 工具的 Win32 移植版本，非常好用。另外 <a href="http://www.cygwin.com/">Cygwin</a> 里的 ln 不但可以创建硬链接也可以创建符号链接(在 Windows 里就是快捷方式 .lnk 文件)。<br/>
<br/>
实际需求引出：Web 应用中上传文到 WEB 下的某个子目录中，这样可以直接通过网页链接的方式访问到这些文件。但是会出现的问题就是，每当完全重新部署应用时，如果忘了把存上传文件的目录进行备份，那么原有上传文件就全没了。原来项目部署在 Unix 下的做法是，把那个上传目录作为另一个目录的符号链接，实际存储文件的目录不在 WEB 应用目录下，重新部署时只要重建这个符号链接即可，不会有覆盖文件的危险。当然在 Unix/Linux 是好解决，只要用 ln -s 命令就行，然而对于 Windows 系统却要想点办法，为目录建立快捷的方式是行不通的，目录的链接只会当 lnk 文件对待，在 Explorer 中可以双击打开，但对于网页链接或者 cd 命令是无法正确定位的。于是思考起如何在 Windows 下创建符号连接的问题，才有了上文。<br/>
<br/>
题外：对于以上的需求，可以在 Web 应用外部事先建立好一个目录，赋上相应的权限。然后在应用的配置文件中记下这个目录的绝对路径，上传时往其中写文件没问题，关键浏览时，因为文件在应用之后，不能直接通过网址浏览到，就需要通过一个程序去读取相应的文件，发送到浏览器之前必须设置根据文件类型设置响应 MINE 类型，这个 MINE 类型可以在上传时记载在库的。<br/>
<br/>
现在觉得这种方法还优于用符号链接的方式，至为无需每次完整发布后重创建符号链接，而且实际中也出现过完全重部署后，目标目录中文件完全丢失的情况。<br/>
<br/>
参考：1. <a href="http://www.rainux.org/2004/12/22/18">NTFS 下的硬链接(hard link)与符号链接(symbolic link)</a><br/>
        2. <a href="http://msdn2.microsoft.com/en-us/library/aa363860.aspx">原来Windows下面也有硬链接<br/>
</a>        3. <a href="http://syre.blogbus.com/logs/4081353.html">Windows上创建硬链接</a><br/>
        4. <a href="http://msdn2.microsoft.com/en-us/library/aa363866.aspx">MSDN CreateSymbolicLink Function</a><br/>
        5. <u><span style="color: #800080;"><a href="http://msdn2.microsoft.com/en-us/library/aa363860.aspx">MSDN CreateHardLink Function</a></span></u><br/>
        6. <a href=" http://www.chinaunix.net/jh/7/240100.html">ln命令详细用法</a>
