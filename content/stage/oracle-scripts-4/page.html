---
title: "ORACLE 常用脚本（4）[转]"
url: /oracle-scripts-4/
date: 2006-09-19T00:05:00-05:00
featured: false
draft: true
type: post
toc: false
# menu: main
usePageBundles: true
categories:
  - Database
tags: 
  - Oracle
comment: true
codeMaxLines: 50
# additional
wpPostId: 545 
wpStatus: publish
views: 362
lastmod: 2014-01-28T00:52:01-06:00
---

rem  这需要 统计某个具体用户的"Table,index,column,constraits"<br/>
rem================================================================<br/>
rem   全部表-列定义 table_cols.txt<br/>
 set lin 110 pages 3000<br/>
 column table_name format a30<br/>
 column data_type  format a12<br/>
 column data_default  format a8<br/>
 column column_name format a22<br/>
 column Cid format  999<!--more--><br/>
 column Len format  9999<br/>
 column Prec format  99<br/>
 column Scale format  99<br/>
<br/>
select  TABLE_NAME, COLUMN_ID "Cid", COLUMN_NAME, DATA_TYPE, DATA_LENGTH "Len",<br/>
 nvl(DATA_PRECISION,'-1') "Prec", nvl(DATA_SCALE,'-1') "Scale",<br/>
 NULLABLE,  DATA_DEFAULT<br/>
from   USER_TAB_COLUMNS ;<br/>
<br/>
rem ======== TAB =============<br/>
select * from tab;<br/>
spool off<br/>
<br/>
spool user_indexes.txt<br/>
rem================================================================<br/>
rem   全部索引定义user_index.txt<br/>
 column table_name format a22<br/>
 column index_name format a28<br/>
 column index_type format a7<br/>
 column column_name format a18<br/>
 column # format  99<br/>
 column Init format  999999;<br/>
select  a.table_name, t.cache "C",a.index_name,<br/>
 column_position "#",column_name,<br/>
 UNIQUENESS,a.INITIAL_EXTENT/1024 "Init"<br/>
 from user_indexes a, user_ind_columns c,user_tables t<br/>
 where  c.INDEX_NAME =a.INDEX_NAME <br/>
 and a.table_name= t.table_name<br/>
 order by  a.table_name,a.index_name,column_position;<br/>
spool off<br/>
<br/>
spool user_Obj_Table_Index.txt<br/>
rem================================================================<br/>
rem  用户对象，表和索引userObj_Table_Index.txt<br/>
 set lin 111 pages 333<br/>
 column table_name format a24<br/>
 column index_name format a32<br/>
 column tablespace_name a12<br/>
 column Init format  999999;<br/>
rem 由于用户要关心的是我自己的详细数据的存放位置，下面分别得出index,tables<br/>
 select tablespace_name,table_name,cache,initial_extent/1024 "Init"<br/>
    from user_tables  order by tablespace_name,table_name;<br/>
 select tablespace_name,table_name,index_name,initial_extent/1024 "Init"<br/>
   from user_indexes  order by tablespace_name,table_name,index_name;<br/>
spool off<br/>
<br/>
spool user_constraints.txt<br/>
rem================================================================<br/>
rem   全部表-列约束_user_constraints.txt<br/>
 column CONSTRAINT_NAME format a30<br/>
 column TABLE_NAME format a30<br/>
 column r_CONSTRAINT_NAME format a20<br/>
<br/>
select CONSTRAINT_NAME,<br/>
 CONSTRAINT_TYPE,  TABLE_NAME, R_CONSTRAINT_NAME, DELETE_RULE <br/>
 from user_constraints<br/>
 order by  CONSTRAINT_TYPE,TABLE_NAME;<br/>
spool off<br/>
<br/>
spool c:\user_index1rebld.sql<br/>
rem================================================================<br/>
rem   重建全部索引<br/>
rem select 'alter index '||index_name||' rebuild;' from user_indexes<br/>
rem    where table_name = 'GWNEWS';<br/>
select 'alter index '||INDEX_NAME||' rebuild tablespace indexes;' from user_indexes;<br/>
spool off<br/>
rem @index1rebld.sql<br/>
<br/>
spool c:\user_sources.sql<br/>
rem================================================================<br/>
rem   全部代码，主要是procedure<br/>
 column name format a22 ;<br/>
 column text format a77;<br/>
 break on name;<br/>
select text,name from user_source;<br/>
spool off<br/>
<br/>
rem       =============== End of File ==================<br/>
*************查看当前用户使用的操作****************************<br/>
<br/>
SELECT a.machine,a.terminal,a.osuser, a.username, b.sql_text<br/>
from v$session a, v$sqlarea b<br/>
where a.sql_address =b.address order by b.address<br/>
<br/>
***************************************************<br/>
<br/>
<strong>1. 监控事例的等待</strong><br/>
<br/>
select event,sum(decode(wait_Time,0,0,1)) "Prev",<br/>
sum(decode(wait_Time,0,1,0)) "Curr",count(*) "Tot"<br/>
from v$session_Wait<br/>
group by event order by 4;<br/>
<br/>
<strong>2. 回滚段的争用情况</strong><br/>
<br/>
select name, waits, gets, waits/gets "Ratio"<br/>
from v$rollstat a, v$rollname b<br/>
where a.usn = b.usn;<br/>
<br/>
<strong>3. 监控表空间的 I/O 比例</strong><br/>
<br/>
select df.tablespace_name name,df.file_name "file",f.phyrds pyr,<br/>
f.phyblkrd pbr,f.phywrts pyw, f.phyblkwrt pbw<br/>
from v$filestat f, dba_data_files df<br/>
where f.file# = df.file_id<br/>
order by df.tablespace_name;<br/>
<br/>
<strong>4. 监控文件系统的 I/O 比例</strong><br/>
<br/>
select substr(a.file#,1,2) "#", substr(a.name,1,30) "Name",<br/>
a.status, a.bytes, b.phyrds, b.phywrts<br/>
from v$datafile a, v$filestat b<br/>
where a.file# = b.file#;<br/>
<br/>
<strong>5.在某个用户下找所有的索引</strong><br/>
<br/>
select user_indexes.table_name, user_indexes.index_name,uniqueness, column_name<br/>
from user_ind_columns, user_indexes<br/>
where user_ind_columns.index_name = user_indexes.index_name<br/>
and user_ind_columns.table_name = user_indexes.table_name<br/>
order by user_indexes.table_type, user_indexes.table_name,<br/>
user_indexes.index_name, column_position;<br/>
<br/>
<strong>6. 监控 SGA 的命中率</strong><br/>
<br/>
select a.value + b.value "logical_reads", c.value "phys_reads",<br/>
round(100 * ((a.value+b.value)-c.value) / (a.value+b.value)) "BUFFER HIT RATIO"<br/>
from v$sysstat a, v$sysstat b, v$sysstat c<br/>
where a.statistic# = 38 and b.statistic# = 39<br/>
and c.statistic# = 40;<br/>
<br/>
<strong>7. 监控 SGA 中字典缓冲区的命中率</strong><br/>
<br/>
select parameter, gets,Getmisses , getmisses/(gets+getmisses)*100 "miss ratio",<br/>
(1-(sum(getmisses)/ (sum(gets)+sum(getmisses))))*100 "Hit ratio"<br/>
from v$rowcache<br/>
where gets+getmisses &lt;&gt;0<br/>
group by parameter, gets, getmisses;<br/>
<br/>
<strong>8. 监控 SGA 中共享缓存区的命中率，应该小于1%</strong><br/>
<br/>
select sum(pins) "Total Pins", sum(reloads) "Total Reloads",<br/>
sum(reloads)/sum(pins) *100 libcache<br/>
from v$librarycache;<br/>
<br/>
select sum(pinhits-reloads)/sum(pins) "hit radio",sum(reloads)/sum(pins) "reload percent"<br/>
from v$librarycache;<br/>
<br/>
<strong>9.显示所有数据库对象的类别和大小</strong><br/>
<br/>
select count(name) num_instances ,type ,sum(source_size) source_size ,<br/>
sum(parsed_size) parsed_size ,sum(code_size) code_size ,sum(error_size) error_size,<br/>
sum(source_size) +sum(parsed_size) +sum(code_size) +sum(error_size) size_required<br/>
from dba_object_size<br/>
group by type order by 2;<br/>
<br/>
<strong>10.监控 SGA 中重做日志缓存区的命中率，应该小于1%</strong><br/>
<br/>
SELECT name, gets, misses, immediate_gets, immediate_misses,<br/>
Decode(gets,0,0,misses/gets*100) ratio1,<br/>
Decode(immediate_gets+immediate_misses,0,0,<br/>
immediate_misses/(immediate_gets+immediate_misses)*100) ratio2<br/>
FROM v$latch WHERE name IN ('redo allocation', 'redo copy');<br/>
<br/>
<strong>11.监控内存和硬盘的排序比率，最好使它小于 .10，增加 sort_area_size</strong><br/>
<br/>
SELECT name, value FROM v$sysstat WHERE name IN ('sorts (memory)', 'sorts (disk)');<br/>
<br/>
<strong>12.监控当前数据库谁在运行什么SQL语句</strong><br/>
<br/>
SELECT osuser, username, sql_text from v$session a, v$sqltext b<br/>
where a.sql_address =b.address order by address, piece;<br/>
<br/>
<strong>13.监控字典缓冲区</strong><br/>
<br/>
SELECT (SUM(PINS - RELOADS)) / SUM(PINS) "LIB CACHE" FROM V$LIBRARYCACHE;<br/>
SELECT (SUM(GETS - GETMISSES - USAGE - FIXED)) / SUM(GETS) "ROW CACHE" FROM V$ROWCACHE;<br/>
SELECT SUM(PINS) "EXECUTIONS", SUM(RELOADS) "CACHE MISSES WHILE EXECUTING" FROM V$LIBRARYCACHE;<br/>
<br/>
后者除以前者,此比率小于1%,接近0%为好。<br/>
<br/>
SELECT SUM(GETS) "DICTIONARY GETS",SUM(GETMISSES) "DICTIONARY CACHE GET MISSES"<br/>
FROM V$ROWCACHE<br/>
<br/>
<strong>14.找ORACLE字符集</strong><br/>
<br/>
select * from sys.props$ where name='NLS_CHARACTERSET';<br/>
<br/>
<strong>15. 监控 MTS</strong><br/>
<br/>
select busy/(busy+idle) "shared servers busy" from v$dispatcher;<br/>
<br/>
此值大于0.5时，参数需加大<br/>
<br/>
select sum(wait)/sum(totalq) "dispatcher waits" from v$queue where type='dispatcher';<br/>
select count(*) from v$dispatcher;<br/>
select servers_highwater from v$mts;<br/>
<br/>
servers_highwater接近mts_max_servers时，参数需加大<br/>
<br/>
<strong>16. 碎片程度</strong><br/>
<br/>
select tablespace_name,count(tablespace_name) from dba_free_space group by tablespace_name<br/>
having count(tablespace_name)&gt;10;<br/>
<br/>
alter tablespace name coalesce;<br/>
alter table name deallocate unused;<br/>
<br/>
create or replace view ts_blocks_v as<br/>
select tablespace_name,block_id,bytes,blocks,'free space' segment_name from dba_free_space<br/>
union all<br/>
select tablespace_name,block_id,bytes,blocks,segment_name from dba_extents;<br/>
<br/>
select * from ts_blocks_v;<br/>
<br/>
select tablespace_name,sum(bytes),max(bytes),count(block_id) from dba_free_space<br/>
group by tablespace_name;<br/>
<br/>
查看碎片程度高的表<br/>
<br/>
SELECT segment_name table_name , COUNT(*) extents<br/>
FROM dba_segments WHERE owner NOT IN ('SYS', 'SYSTEM') GROUP BY segment_name<br/>
HAVING COUNT(*) = (SELECT MAX( COUNT(*) ) FROM dba_segments GROUP BY segment_name);<br/>
<br/>
<strong>17. 表、索引的存储情况检查</strong><br/>
<br/>
select segment_name,sum(bytes),count(*) ext_quan from dba_extents where<br/>
tablespace_name='&amp;tablespace_name' and segment_type='TABLE' group by tablespace_name,segment_name;<br/>
<br/>
select segment_name,count(*) from dba_extents where segment_type='INDEX' and owner='&amp;owner'<br/>
group by segment_name;<br/>
<br/>
<strong>18、找使用CPU多的用户session</strong><br/>
<br/>
12是cpu used by this session<br/>
<br/>
select a.sid,spid,status,substr(a.program,1,40) prog,a.terminal,osuser,value/60/100 value<br/>
from v$session a,v$process b,v$sesstat c<br/>
where c.statistic#=12 and c.sid=a.sid and a.paddr=b.addr order by value desc;<br/>
<br/>
<strong>19、查看Lock</strong><br/>
<br/>
SELECT sn.username, m.sid, m.type,<br/>
DECODE(m.lmode, 0, 'None',<br/>
1, 'Null',<br/>
2, 'Row Share',<br/>
3, 'Row Excl.',<br/>
4, 'Share',<br/>
5, 'S/Row Excl.',<br/>
6, 'Exclusive',<br/>
lmode, ltrim(to_char(lmode,'990'))) lmode,<br/>
DECODE(m.request,0, 'None',<br/>
1, 'Null',<br/>
2, 'Row Share',<br/>
3, 'Row Excl.',<br/>
4, 'Share',<br/>
5, 'S/Row Excl.',<br/>
6, 'Exclusive',<br/>
request, ltrim(to_char(m.request,<br/>
'990'))) request,<br/>
m.id1, m.id2<br/>
FROM v$session sn, v$lock m<br/>
WHERE (sn.sid = m.sid AND m.request != 0)<br/>
OR (sn.sid = m.sid<br/>
AND m.request = 0 AND lmode != 4<br/>
AND (id1, id2) IN (SELECT s.id1, s.id2<br/>
FROM v$lock s<br/>
WHERE request != 0<br/>
AND s.id1 = m.id1<br/>
AND s.id2 = m.id2)<br/>
)<br/>
ORDER BY id1, id2, m.request;<br/>
select l.sid,s.serial#,s.username,s.terminal,<br/>
decode(l.type,'RW','RW - Row Wait Enqueue',<br/>
'TM','TM - DML Enqueue',<br/>
'TX','TX - Trans Enqueue',<br/>
'UL','UL - User',l.type||'System') res,<br/>
substr(t.name,1,10) tab,u.name owner,<br/>
l.id1,l.id2,<br/>
decode(l.lmode,1,'No Lock',<br/>
2,'Row Share',<br/>
3,'Row Exclusive',<br/>
4,'Share',<br/>
5,'Shr Row Excl',<br/>
6,'Exclusive',null) lmode,<br/>
decode(l.request,1,'No Lock',<br/>
2,'Row Share',<br/>
3,'Row Excl',<br/>
4,'Share',<br/>
5,'Shr Row Excl',<br/>
6,'Exclusive',null) request<br/>
from v$lock l, v$session s,<br/>
sys.user$ u,sys.obj$ t<br/>
where l.sid = s.sid<br/>
and s.type != 'BACKGROUND'<br/>
and t.obj# = l.id1<br/>
and u.user# = t.owner#<br/>
--第二条语句比较有效。<br/>
<br/>
<strong>20、显示表空间的使用情况：</strong><br/>
<br/>
col tsname format a16 justify c heading 'Tablespace'<br/>
col nfrags format 999,990 justify c heading 'Free|Frags'<br/>
col mxfrag format 999,999,990 justify c heading 'Largest|Frag (KB)'<br/>
col totsiz format 999,999,990 justify c heading 'Total|(KB)'<br/>
col avasiz format 999,999,990 justify c heading 'Available|(KB)'<br/>
col pctusd format 990 justify c heading 'Pct|Used'<br/>
select<br/>
total.tablespace_name tsname,<br/>
count(free.bytes) nfrags,<br/>
nvl(max(free.bytes)/1024,0) mxfrag,<br/>
total.bytes/1024 totsiz,<br/>
nvl(sum(free.bytes)/1024,0) avasiz,<br/>
(1-nvl(sum(free.bytes),0)/total.bytes)*100 pctusd<br/>
from<br/>
dba_data_files total,<br/>
dba_free_space free<br/>
where<br/>
total.tablespace_name = free.tablespace_name(+)<br/>
group by<br/>
total.tablespace_name,<br/>
total.bytes;
