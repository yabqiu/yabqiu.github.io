---
title: AWS Windows EC2 实例的 userdata 应用笔记
url: /aws-windows-ec2-instance-userdata-note/
date: 2022-02-14T13:59:26-06:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/http://unmi.cc/wp-content/uploads/2017/03/aws-logo.png"
categories:
  - AWS
tags: 
  - AWS
  - EC2
  - userdata
  - PowerShell
comment: true
codeMaxLines: 50
# additional
wpPostId: 12273 
wpStatus: publish
views: 662
lastmod: 2022-02-17T22:47:17-06:00
---

因为平常主要是使用 EC2 的 Linux 实例，所以之前写过的一篇关于 UserData 的日志 <a href="https://yanbin.blog/launch-aws-ec2-instance-userdata-knowledge/">创建 AWS EC2 实例时 userdata 的一些知识</a> 默认就是讲的有关 Linux 实例的 UserData。本文补充上 Windows 的 EC2 实例 UserData 的基本使用，参考自 AWS 官方文档 <a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-windows-user-data.html">Run commands on your Windows instance at launch</a>。<br/><br/>
Windows 的 UserData 被谁执行，依据所选择 AMI 的不同有以下三种方式<br/><br/>
<ol>
    <li>EC2Launch v2: 最新方式，只是被当前预览版的 AMI 所支持，它支持 YAML 配置的脚本</li>
    <li>EC2Launch: 当前方式，Windows Server 2016 及更新版</li>
    <li>EC2Cofnig: 旧有方式， Windows Sever 2012 R2 及旧版本</li>
</ol>
<br/>
<!--more--><br/><br/>
<h3>UserData 脚本的语法</h3><br/><br/>
可支持 batch, PowerShell, 或 YAML 配置(EC2Launch), 和 Linux 下的 UserData 要求 Shebang(#!) 类似，Windows 的 UserData 中必须用标签来指定是何种脚本方式。如果 UserData 中同时声明有 <code>&lt;script&gt;</code> 和 <code>&lt;powershell&gt;</code>, 那么总是先执行 <code>&lt;script&gt;</code>, 再执行 <code>&lt;powershell&gt;</code>, 与它们的声明先后顺序无关。<br/><br/>
<h4>batch 脚本</h4><br/><br/>
<pre class="lang:default decode:true ">&lt;script&gt;
echo batch scripts ....
&lt;/script&gt;
&lt;persist&gt;true&lt;/persist&gt;</pre>
<br/>
<code>&lt;persist&gt;</code> 是可选的，默认为 false, 即 userdata 只在初始化实例时运行一次，persist 为 true 是则在实例重启时也被执行<br/><br/>
<h4>PowerShell 脚本</h4><br/><br/>
<pre class="lang:default decode:true">&lt;powershell&gt;
New-Item test.txt -ItemType file
&lt;/powershell&gt;
&lt;persist&gt;true&lt;/persist&gt;</pre>
<br/>
PowerShell 中除了能执行 batch 脚本外，还有更强大的功能。<code>&lt;persist&gt;</code> 的功用与上相同<br/><br/>
<h4>YAML 配置脚本</h4><br/><br/>
如果 UserData 由 EC2Launch v2 来执行，就可用 YAML 方式来配置脚本<br/><br/>
<pre class="lang:default decode:true">version: 1.0
tasks:
- task: executeScript
  inputs:
  - frequency: always
    type: powershell
    runAs: localSystem
    content: |-
      $file = $env:SystemRoot + "\Temp\" + (Get-Date).ToString("MM-dd-yy-hh-mm")
      New-Item $file -ItemType file</pre>
<br/>
<code>frequency</code> 的 <code>once</code>, <code>always</code> 取值与前面的 <code>&lt;persist&gt;</code> <code>false</code>, <code>true</code> 是一致的。<br/><br/>
<h3>UserData 执行的日志</h3><br/><br/>
日志是非常重要的，同样根据发起执行者的不同而记录在不同的位置。注：<code>C:\ProgramData</code> 是一个隐藏目录。<br/><br/>
EC2Launch v2: <code>C:\ProgramData\Amazon\EC2Launch\log\agent.log</code><br/><br/>
EC2Launch: <code>C:\ProgramData\Amazon\EC2-Windows\Launch\Log\UserdataExecution.log</code><br/><br/>
EC2Config: <code>C:\Program Files\Amazon\Ec2ConfigService\Logs\EC2Config.log</code><br/><br/>
<h3>每次启动(含重启)都执行 UserData</h3><br/><br/>
希望每次都执行 UserData, 或在实例初始化后对 UserData 进行的更新后在重启后得到执行<br/><br/>
<ol>
    <li>配置 <code>&lt;persist&gt;true&lt;/persist&gt;</code> 或 <code>frequency</code> 为 always</li>
    <li>EC2Launch: 运行 <code>C:\ProgramData\Amazon\EC2-Windows\Launch\Scripts\InitializeInstance.ps1 –Schedule</code> 启用调度任务</li>
    <li>Ec2Config: 运行 <code>C:\Program Files\Amazon\Ec2ConfigService\Ec2ConfigServiceSetting.exe</code>，然后开启</li>
</ol>
<br/>
<h3>PowerShell 的一些工具</h3><br/><br/>
除了直接使用 awscli 外，可直接使用 PowerShell 下的 AWS Tools, 参考 <a href="https://docs.aws.amazon.com/powershell/latest/reference/">AWS Tools for PowerShell Cmdlet Reference</a>。其实就是以 PowerShell 的方式来使用 awscli。<br/><br/>
<pre class="lang:default decode:true">&lt;powershell&gt;
Copy-S3Object -BucketName test-bucket -Key abc/test.txt -LocalFile test.txt
&lt;/powershell&gt;</pre>
<br/>
不过对于用习惯了 awscli 的人来说，PowerShell 的对象操作方式有点罗嗦。<br/><br/>
<h3>其他</h3><br/><br/>
对于 Windows 的实例我仍然是延续着非必要不进入它的远程桌面，所以通常是用 AWS SSM 连接到 Windows EC2 实例的 PowerShell，Linux 可参考 <a href="https://yanbin.blog/aws-session-manager-ec2-instance/">AWS Session Manager 管理 EC2 实例</a>。连接 Windows 的 Session Manager 也类似，两个基本条件，SSM Agent + 有 AmazonSSMManagedInstanceCore 策略的 Instance Profile. 连接用<br/><br/>
<blockquote>
$ aws ssm start-session --target  &lt;INSTANCE_ID&gt;
</blockquote>
<br/>
有些 Windows AMI 会配置 ssh<br/><br/>
点击该链接进入 <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-content?view=powershell-7.2">PowerShell 命令参考</a><br/><br/>
<h4>查看 Windows 系统信息</h4><br/><br/>
<blockquote>
systeminfo
</blockquote>
<br/>
而且在 PowerShell 中 cat, rm, curl/wget 等命令也能直接使用，它们映射到了 Get-Content, Remove-Item 和 Invoke-WebRequest 命令。更多的 GNU 命令还有待以后发掘。<br/><br/>
<h4>下载和安装 VC 运行时</h4><br/><br/>
<pre class="lang:default decode:true ">Invoke-WebRequest -Uri https://aka.ms/vs/17/release/vc_redist.x64.exe -OutFile vc_redist.x64.exe `
Start-Process -filepath vc_redist.x64.exe -ArgumentList "/install", "/passive", "/norestart", "/log log.txt" -Passthru | wait-process</pre>
<br/>
Get-VcList 的安装参考 <a href="https://vcredist.com/quick/">VcRedist docs/Quick install</a>, 如果上面安装的 vc_redist 没效的话，可以试下 VcRedist<br/><br/>
<pre class="lang:default decode:true ">Set-ExecutionPolicy Bypass -Scope Process -Force; `
 [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; `
 iex ((New-Object System.Net.WebClient).DownloadString('https://vcredist.com/install.ps1'))</pre>
<br/>
执行 PowerShell 前设置以下几个选项很有必要<br/><br/>
<pre class="lang:default decode:true ">$ErrorActionPreference = "Stop"                          # 出现错误时不执行后续的脚本
$ProgressPreference = 'SilentlyContinue'                 # 不显示操作的进度，如下载，解压大文件时
$PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'  # 重定向 &gt;, 或管道操作 | 用 Out-File 时的默认字符集，否则可能为 UTF16-LE</pre>
<br/>
想要用其他的  Linux 命令也没问题<br/><br/>
<blockquote>
choco install awk grep sed wget curl -y
</blockquote>
