---
title: Docker Compose ç®€å•é…ç½® Apache Airflow 3.0(PostgreSQL)
url: /use-docker-compose-config-apache-airflow-3-0-postgresql/
date: 2025-05-07T23:14:41-05:00
featured: false
draft: true
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/https://yanbin.blog/wp-content/uploads/2022/08/airflow-logo.png"
categories:
  - Airflow
tags: 
  - Schedule
  - Airflow
comment: true
codeMaxLines: 50
# additional
wpPostId: 14173 
wpStatus: publish
views: 492
lastmod: 2025-05-21T13:03:32-05:00
---

Apache Airflow é‡æ–°å”¤èµ·æˆ‘çš„æ³¨æ„åŠ›æ˜¯å› ä¸º Airflow 3.0 åœ¨è¿‘æ—¥ April 22, 2025 å‘å¸ƒäº†ï¼Œå…¶äºŒåˆ™æ˜¯æˆ‘ä»¬ä¸€ç›´éƒ½æœ‰è®¡åˆ’ä»»åŠ¡çš„éœ€æ±‚ï¼Œä»¥ä¸‹å‡ ç§æ–¹æ¡ˆéƒ½å¤ªç®€é™‹<br/><br/>
<ol>
    <li>ç”¨ Windows çš„è®¡åˆ’ä»»åŠ¡æˆ– Linux çš„ Cron éƒ½ä¸æ˜“ç®¡ç†ï¼Œä¸”æœ‰å•ç‚¹æ•…éšœé—®é¢˜</li>
    <li>åœ¨ Java Spring é¡¹ç›®ä¸­ä½¿ç”¨é›†ç¾¤æ¨¡å¼çš„ Quartz æœ‰äº›éº»çƒ¦ï¼Œä¸”å¯¹äº AutoScalingÂ ä¹Ÿä¸æ€ä¹ˆå‹å¥½</li>
    <li>AWS ä¸Šç”¨ CloudWatch Rule + AWS Lambda çš„æ–¹æ¡ˆå¯é æ€§æ²¡æœ‰é—®é¢˜ï¼Œä½†ä¸é€‚äºç›‘æ§Â </li>
</ol>
<br/>
å› æ­¤è¿˜æœ‰å¿…è¦å†æ¬¡å°è¯• Apache Airflow, å®ƒæœ‰é›†ä¸­ç®¡ç†çš„ç•Œé¢ï¼Œå„ä¸ªéƒ¨ä»¶éƒ½æ˜¯å¯ä¼¸ç¼©çš„ï¼Œå¦‚ WebServer, Workers ç­‰ã€‚ç‰¹åˆ«æ˜¯åˆšå‡ºçš„ Apache Airflow 3.0 å¸¦æ¥ä»¥ä¸‹ä¸»è¦æ–°ç‰¹æ€§<br/><br/>
<ol>
    <li>æ–°çš„æœåŠ¡åŒ–æ¶æ„ï¼Œå„ä¸ªéƒ¨ä»¶é—´è€¦åˆåº¦é™ä½</li>
    <li>å¤šè¯­è¨€æ”¯æŒï¼Œå€ŸåŠ©äº† Task SDK, å¯æœ›ç”¨ Java, JavaScript, TypeScript ç­‰è¯­è¨€å†™ DAG</li>
    <li>DAG æ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼Œå¯å›æº¯å†å²</li>
    <li>æ”¯æŒäº‹ä»¶é©±åŠ¨ï¼Œå³Â  DAG å¯å“åº”å¤–éƒ¨äº‹ä»¶ï¼Œå¦‚æ–‡ä»¶åˆ°è¾¾ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç­‰</li>
    <li>å¼•å…¥äº†èµ„äº§é©±åŠ¨è°ƒåº¦åŠŸèƒ½ï¼Œå¯æ ¹æ®æ•°æ®èµ„äº§çš„å˜åŒ– è¿›è¡Œè§¦å‘ï¼Œå¯ä»¥è¯´æ˜¯äº‹ä»¶é©±åŠ¨çš„ä¸€ç±»</li>
    <li>å…¨æ–°çš„ React UIÂ ç•Œé¢</li>
</ol>
<br/>
<!--more-->Apache Airflow æä¾›äº†å¤šç§å®‰è£…éƒ¨ç½²æ–¹å¼ï¼Œå¦‚ pip, uv å®‰è£…ï¼ŒDocker æˆ– Docker Compose, åœ¨ Kubernetes ç¯å¢ƒå¯ç”¨å®˜æ–¹çš„ Helmã€‚<br/><br/>
æœ¬æ–‡æ¬²å°è¯•çš„æ˜¯ç”¨ Docker Compose çš„æ–¹å¼åœ¨æœ¬åœ°è¿›è¡Œéƒ¨ç½²ï¼Œä¸é»˜è®¤çš„ airflow standalone æ–¹å¼å”¯ä¸€ä¸åŒçš„åªæ˜¯æŠŠæ•°æ®åº“ç‹¬ç«‹äº†å‡ºæ¥ï¼Œä¸å†ä½¿ç”¨å†…ç½®çš„ SQLiteï¼Œä»ç„¶ä½¿ç”¨å•ä½“ä¸­çš„ WebServer, Scheduler, Workers, TriggererÂ ç­‰éƒ¨ä»¶ã€‚<br/><br/>
è¿™æ˜¯å®˜æ–¹çš„ <a href="https://airflow.apache.org/docs/apache-airflow/3.0.0/docker-compose.yaml">docker-compose.yaml</a>, æœ¬æ–‡å¯¹äº›æœ‰å°‘è®¸å‚è€ƒï¼Œè¯¥ docker-coompose é…ç½®æ–‡ä»¶ä¸­å«æœ‰ 8 ä¸ª service,Â åˆ†åˆ«æ˜¯<br/><br/>
<ol>
    <li>airflow-scheduler</li>
    <li>airflow-dag-processor</li>
    <li>airflow-api-server</li>
    <li>airflow-worker</li>
    <li>airflow-triggerer</li>
    <li>airflow-init</li>
    <li>postgres</li>
    <li>redis</li>
</ol>
<br/>
æ­¤å¤„å°½é‡ç®€åŒ–ï¼Œåªæœ‰ä¸¤ä¸ª service -- postgres å’ŒÂ  airflow. Airflow å°†ä½¿ç”¨ <code>airflow standalone</code> å¯åŠ¨ï¼Œæ‰€å®ƒæ¶µç›–äº†ä»¥ä¸Š 1 - 5 çš„åŠŸèƒ½ã€‚<br/><br/>
Apache Airflow é•œåƒæ˜¯ä» Python:3.12-slim-bookworm æ„å»ºçš„ã€‚<br/><br/>
<h3>å‡†å¤‡ç›®å½•ç»“æ„</h3><br/><br/>
é¦–å…ˆåœ¨å½“å‰ç›®å½•ä¸­åˆ›å»ºä¸‹é¢ç»“æ„ï¼Œæ‰€åˆ›å»ºçš„ç©ºç›®å½•æ˜¯ä¸ºäº†æ˜ å°„åˆ°å®¹å™¨å½“ä¸­å»çš„ã€‚<br/><br/>
<pre class="lang:default decode:true ">mkdir ./{config,dags,logs,plugins,postgres-data}
touch Dockerfile docker-compose.yml<br/><br/>
.
â”œâ”€â”€ config
â”œâ”€â”€ dags
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ logs
â”œâ”€â”€ plugins
â””â”€â”€ postgres-data</pre>
<br/>
DockerfileÂ æ–‡ä»¶å†…å®¹<br/><br/>
Dockerfile æ˜¯ç”¨æ¥æ„å»º Airflow æœåŠ¡çš„<br/><br/>
<pre class="lang:default decode:true ">FROM python:3.12-bookworm<br/><br/>
ENV AIRFLOW_HOME=/opt/airflow<br/><br/>
WORKDIR ${AIRFLOW_HOME}<br/><br/>
ARG CONSTRAINT_URL=https://raw.githubusercontent.com/apache/airflow/constraints-3.0.0/constraints-3.12.txt<br/><br/>
RUN pip install "apache-airflow[postgres]==3.0.0" --constraint ${CONSTRAINT_URL} &amp;&amp; \
    pip install flask_appbuilder<br/><br/>
ENTRYPOINT ["bash]
</pre>
<br/>
åœ¨ DAG ä¸­å°†è¦ç”¨åˆ°çš„ Python ç»„ä»¶ç”¨Â  pip install å®‰è£…å³å¯ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä»»åŠ¡å°†ä¸ AWSÂ  äº¤äº’ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨ <code>RUN</code>Â ä¸­åŠ ä¸Šä¸€ä¸ª<br/><br/>
<blockquote>
pip install boto3
</blockquote>
<br/>
Airflow å°†ä½¿ç”¨ PostgreSQL æ•°æ®åº“ï¼Œæ‰€ä»¥é€‰æ‹©äº† <code>apache-airflow[postgres]</code>ã€‚<code>ENTRYPOINT</code> æ— æ‰€è°“ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šåœ¨åé¢ç”¨ docker-compose.yml æ¥æŒ‡å®šå¦‚ä½•å¯åŠ¨Â  airflow æœåŠ¡ã€‚<br/><br/>
<h3>ç¼–å†™ docker-compose.ymlÂ æ–‡ä»¶</h3><br/><br/>
docker-compose.yml å®šä¹‰äº†å¦‚ä½•å¯åŠ¨å®¹å™¨ï¼Œairflow éœ€è¦ç”¨æ„å»º Dockerfile æ„å»ºçš„å®¹å™¨ï¼Œpostgres æ˜¯ä» docker hub ä¸­æ‹‰å–çš„ã€‚<br/><br/>
è¯¥æ–‡ä»¶å†…å®¹<br/><br/>
<pre class="lang:default decode:true">services:
    airflow:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - "8080:8080"
        depends_on:
            postgres:
                condition: service_healthy 
        healthcheck:
            test: ["CMD", "curl", "--fail", "http://localhost:8080/api/v2/version"]
        restart: always
        volumes:
            - ./dags:/opt/airflow/dags
            - ./logs:/opt/airflow/logs
            - ./config:/opt/airflow/config
            - ./plugins:/opt/airflow/plugins
        environment:
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
            AIRFLOW__CORE__LOAD_EXAMPLES: false
            AIRFLOW__WEBSERVER__EXPOSE_CONFIG: true
        entrypoint: ["airflow", "standalone"]<br/><br/>
    postgres:
        image: postgres:16-bookworm
        environment:
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_DB: airflow
        volumes:
            - ./postgres-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "airflow"]
        restart: always </pre>
<br/>
å‰é¢è¯´è¿‡ï¼Œè¿™é‡Œåªå®šä¹‰äº†ä¸¤ä¸ªæœåŠ¡ï¼Œairflow å’ŒÂ  postgresã€‚ä¸¤ä¸ªå®¹å™¨éƒ½åŠ å…¥äº† healthcheck, airflow ä¾èµ–äº postgres, åªæœ‰ postgres æ•°æ®åº“å°±ç»ªååœ°ä¼šå¼€å§‹å¯åŠ¨Â  airflow æœåŠ¡ã€‚<br/><br/>
ç•™æ„å…¶ä¸­çš„å·æ˜ å°„ï¼Œä»¥åŠæ•°æ®åº“çš„åç§°ï¼Œç”¨æˆ·ååŠå¯†ç é…ç½®ï¼Œåœ¨ airflow æœåŠ¡ä¸­é€šè¿‡é…ç½®ç¯å¢ƒå˜é‡<br/><br/>
<blockquote>
AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
</blockquote>
<br/>
ä½¿ç”¨ postgres å®¹å™¨ä¸­çš„æ•°æ®åº“<br/><br/>
docker-compose ä¸­å®šä¹‰çš„æœåŠ¡ä¼šä½¿ç”¨ç›¸åŒçš„ç½‘ç»œï¼Œæ‰€ä»¥ postgres ä¸éœ€è¦æš´éœ² 5432 æ•°æ®åº“ç«¯å£åœ¨ airflow æœåŠ¡ä¸­åŒæ ·èƒ½è®¿é—®åˆ°ã€‚ç”±äºæˆ‘ä»¬è¦åœ¨å¤–éƒ¨è®¿é—® airflow çš„ web æœåŠ¡ï¼Œå› æ­¤åœ¨ airflow æ˜ å°„äº†ç«¯å£å· 8080:8080<br/><br/>
<h3>å¯åŠ¨ airflow å’Œ postgresÂ æœåŠ¡</h3><br/><br/>
ä¸‹é¢ä¸€äº›æ“ä½œå°†è¦åˆ°åˆ° docker-composeÂ  å‘½ä»¤, å®ƒä¸ docker å‘½ä»¤æœ‰äº›ç±»å‹, docker-compose æ˜¯æ¯” Kubernetes æ›´ç®€å•çš„å®¹å™¨ç¼–æ’å·¥å…·ã€‚Docker Swarm + Docker Compose ä¹Ÿèƒ½å¤Ÿç±»ä¼¼äº Kubernetes é‚£æ ·åœ¨é›†ç¾¤ç¯å¢ƒä¸­ç¼–æ’å®¹å™¨æœåŠ¡ï¼Œå½“ç„¶ä¸å…·æœ‰ Kubernetes çš„å¤æ‚åº¦å’Œå®Œå¤‡çš„åŠŸèƒ½ï¼Œä¸­å°å‹çš„åº”ç”¨è¿˜æ˜¯èƒ½å°±ä¼šçš„ã€‚<br/><br/>
å¯åŠ¨ docker-compose.ymlÂ ä¸­å®šä¹‰çš„æœåŠ¡çš„å‘½ä»¤æ˜¯<br/><br/>
<blockquote>
docker-compose up
</blockquote>
<br/>
å¦‚æœ <code>docker-compose up</code> å‘ç°æ²¡æœ‰æ„å»ºå¥½ airflow é•œåƒï¼Œä¼šé¦–å…ˆæ„å»ºç›¸åº”çš„é•œåƒï¼Œå°±åƒæ˜¯äº‹å…ˆæ‰§è¡Œäº†<br/><br/>
<blockquote>
docker-compose build
</blockquote>
<br/>
å‘½ä»¤ä¸€æ ·<br/><br/>
ä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œæ•°æ®åº“å‡†å¤‡ï¼Œå¹¶ä¸”åœ¨å¯åŠ¨Â  airflow æœåŠ¡çš„ <code>airflow standalone</code> å‘½ä»¤æ—¶ä¼šè‡ªåŠ¨è¿æ¥ postgres æ•°æ®åº“å¹¶åˆå§‹åŒ–æ•°æ®åº“ Schema<br/><br/>
ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨è®¿é—® <a href="http://localhost:8080/">http://localhost:8080</a>ï¼Œè¢«è¦æ±‚è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œè¦åˆ° airflowÂ å®¹å™¨ä¸­å»å¯»æ‰¾<br/><br/>
docker ps æˆ– docker-compose ps å‘½ä»¤åˆ—å‡ºæ‰€æœ‰å¯åŠ¨çš„å®¹å™¨<br/><br/>
<pre class="lang:default decode:true">docker-compose ps
NAME                      IMAGE                  COMMAND                  SERVICE    CREATED         STATUS                   PORTS
airflow-test-airflow-1    airflow-test-airflow   "airflow standalone"     airflow    6 minutes ago   Up 5 minutes (healthy)   0.0.0.0:8080-&gt;8080/tcp
airflow-test-postgres-1   postgres:16-bookworm   "docker-entrypoint.sâ€¦"   postgres   6 minutes ago   Up 6 minutes (healthy)   5432/tcp</pre>
<br/>
ä¸ºä»€ä¹ˆä¼šæœ‰ä¸ªÂ  <code>airflow-test</code> å‰ç¼€ï¼Œå› ä¸ºæˆ‘çš„å·¥ä½œç›®å½•æ˜¯ <code>airflow-test</code><br/><br/>
è¾“å…¥å‘½ä»¤<br/><br/>
<blockquote>
docker-compose exec -it airflow bash
</blockquote>
<br/>
è¿›åˆ°Â  airflowÂ å®¹å™¨<br/><br/>
<pre class="lang:default decode:true ">airflow-test docker-compose exec -it airflow bash
root@9f40597439df:/opt/airflow# ls
airflow.cfg  config  dags  logs  plugins  simple_auth_manager_passwords.json.generated
root@9f40597439df:/opt/airflow# cat simple_auth_manager_passwords.json.generated
{"admin": "qC2adgwMqY4mZdZt"}</pre>
<br/>
æœ‰çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç™»é™† http://localhost:8080Â åå°±æ˜¯<br/><br/>
<a href="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-1.png"><img class="aligncenter wp-image-14177" src="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-1-800x534.png" alt="" width="850" height="567" /></a><br/><br/>
ç•Œé¢ä¸ Apache Airflow 2 æ¯”èµ·æ¥è¿˜æ˜¯æ¸…çˆ½äº†è®¸å¤šã€‚<br/><br/>
å†™ä¸€ä¸ªæœ€ç®€å•çš„ DAG æ–‡ä»¶ hello_dag.py<br/><br/>
<pre class="lang:default decode:true">from airflow.decorators import dag, task
from datetime import datetime<br/><br/>
@dag(
    schedule="@daily",                  # run once daily
    start_date=datetime(2024, 1, 1),    # start date for DAG
    catchup=False,                      # don't backfill
    tags=["example"],
)
def hello_dag():
    @task
    def hello():
        print("ğŸ‘‹ Hello from Airflow 3.0!")<br/><br/>
    hello()<br/><br/>
dag = hello_dag() </pre>
<br/>
æ”¾ç½®åœ¨Â  <code>./dags</code> ç›®å½•ï¼Œè¿‡æœ€å¤š 5 åˆ†é’Ÿï¼Œå°±èƒ½åœ¨ http://localhost:8080/dags é¡µé¢ä¸­åˆ·å‡ºå®ƒæ¥ã€‚<br/><br/>
<a href="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-2.png"><img class="aligncenter wp-image-14178" src="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-2-800x534.png" alt="" width="850" height="567" /></a>Â Â <br/><br/>
åœ¨ä¸Šå›¾ä¸­çš„ hello_dagï¼Œæˆ‘æ‰‹å·¥è§¦å‘æ‰§è¡Œäº†å®ƒä¸€æ¬¡ã€‚<br/><br/>
å…¶ä»– Apache Airflow 3.0 æ–°åŠŸèƒ½ï¼Œè¯¸å¦‚ Assets, Admin ä¸­çš„ Variables, Pools, Providers, Plugins, Connections, Config åŠŸèƒ½éƒ½å€¼å¾—ä»¥åå°±æ·±ç©¶ã€‚<br/><br/>
ç”±äºåœ¨ docker-compose.yml é…ç½®äº† AIRFLOW__CORE__LOAD_EXAMPLES: false ç¯å¢ƒå˜é‡ï¼Œå¦‚æœæœ€åˆæ²¡æœ‰è¯¥ç¯å¢ƒå˜é‡å˜é‡æˆ–ä¸º true çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šçœ‹åˆ°è®¸å¤šçš„ç¤ºä¾‹ Dags å’Œ Assetsã€‚æˆ–è€…ç›´æ¥è®¿é—® <a href="https://github.com/apache/airflow/tree/main/airflow-core/src/airflow/example_dags">airflow/airflow-core/src/airflow/example_dags/</a>Â æŸ¥çœ‹å®˜æ–¹æä¾›çš„æ‰€æœ‰ç¤ºä¾‹<br/><br/>
<a href="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-3.png"><img class="aligncenter wp-image-14179" src="https://yanbin.blog/wp-content/uploads/2025/05/apache-airflow-3.0-3-800x534.png" alt="" width="850" height="567" /></a><br/><br/>
çœ‹åˆ°è¿™äº›ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å€ŸåŠ©äº S3 Event åšäº›ä»€ä¹ˆäº‹æƒ…ã€‚<br/><br/>
<h3>å…¶ä»–ç›¸å…³å†…å®¹</h3><br/><br/>
airflow standalone ä¸å»ºè®®ä½¿ç”¨ï¼Œä½†ä¸ªäººè®¤ä¸ºå¯¹äºåªéœ€ Airflow åšç®€å•çš„äº‹æƒ…çš„åº”ç”¨æœªå°ä¸å¯ï¼Œæ¯”å¦‚åªéœ€è¦å®šæ—¶è°ƒç”¨æŸä¸ª HTTP æœåŠ¡ï¼Œä½“åŠ›æ´»ç”±å¯¹åº”çš„ HTTP æœåŠ¡å»å¤„ç†ï¼Œå³çº¯ç²¹çš„ä»»åŠ¡è°ƒåº¦ã€‚<br/><br/>
å¦‚æœæˆ‘ä»¬æŸ¥çœ‹ <code>airflow standalone</code> å¯åŠ¨äº†å“ªäº›æœåŠ¡ï¼Œç”¨å‘½ä»¤ docker-compose exec airflow ps -ef<br/><br/>
<pre class="lang:default decode:true">$ docker-compose exec  airflow ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 03:27 ?        00:00:02 /usr/local/bin/python3.12 /usr/local/bin/airflow standalone
root         9     1  3 03:27 ?        00:00:25 /usr/local/bin/python3.12 /usr/local/bin/airflow scheduler
root        11     1  7 03:27 ?        00:00:53 /usr/local/bin/python3.12 /usr/local/bin/airflow dag-processor
root        13     1  0 03:27 ?        00:00:04 /usr/local/bin/python3.12 /usr/local/bin/airflow api-server
root        15     1  2 03:27 ?        00:00:16 /usr/local/bin/python3.12 /usr/local/bin/airflow triggerer
root        20    13  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 -c from multiprocessing.resource_tracker import main;main(10)
root        21    13  1 03:27 ?        00:00:09 /usr/local/bin/python3.12 -c from multiprocessing.spawn import spawn_main; spawn_main(tracke
root        22    13  1 03:27 ?        00:00:10 /usr/local/bin/python3.12 -c from multiprocessing.spawn import spawn_main; spawn_main(tracke
root        23    13  1 03:27 ?        00:00:09 /usr/local/bin/python3.12 -c from multiprocessing.spawn import spawn_main; spawn_main(tracke
root        24    13  1 03:27 ?        00:00:10 /usr/local/bin/python3.12 -c from multiprocessing.spawn import spawn_main; spawn_main(tracke
root        25    15  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow triggerer
root        26     9  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow scheduler
root        27    26  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow scheduler
root        28    25  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow triggerer
root        29    25  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow triggerer
root        30    26  0 03:27 ?        00:00:00 /usr/local/bin/python3.12 /usr/local/bin/airflow scheduler
root        31    15  0 03:27 ?        00:00:05 /usr/local/bin/python3.12 /usr/local/bin/airflow triggerer</pre>
<br/>
æ‰€æœ‰æœåŠ¡ä¸€åº”å…·æƒï¼Œç²¾ç»†ç‚¹æ§åˆ¶å¯ä»¥ scheduler, api-server, triggerer ç­‰æœåŠ¡é€ä¸ªå¯åŠ¨ï¼Œå¹¶æŒ‡å®š Replica ä¸ªæ•°ã€‚åŸºæœ¬çš„ Apache Airflow éƒ½å¯ä»¥ä» airflow standalone å¼€å§‹ï¼Œè¿è¡Œåæ ¹æ®å®é™…çŠ¶å†µå¯¹ä¸åŒéƒ¨ä»¶è¿›è¡Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæˆ–è€…å¼•å…¥ Redis + Celery ä½¿ç”¨åˆ†å¸ƒå¼çš„ WorkerÂ  -- CeleryExecutor.<br/><br/>
docker-composeÂ çš„ç›¸å…³æ“ä½œ<br/><br/>
docker-compose.yml ä¸­å®šä¹‰çš„æœåŠ¡æ˜¯å¯ä»¥å•ç‹¬å¯åŠ¨çš„ï¼Œå¦‚<br/><br/>
<blockquote>
docker-compose up postgres
docker-compose run --entrypoint bash -p 8080:8080 airflow<br />
Â  Â  Â  airflow db migrate<br />
Â  Â  Â  airflow standalone
</blockquote>
<br/>
airflow db migrate ç›¸å½“äºä»¥å‰ç‰ˆæœ¬çš„Â  airflow db init åˆå§‹åŒ–æ•°æ®åº“ï¼Œå…¼å…·ä»æ—§ Airflow æ•°æ®åº“å‡çº§åˆ°æ–°ç‰ˆæœ¬ã€‚<br/><br/>
åœ¨ airflow å®¹å™¨ä¸­æ‰§è¡Œäº† airflow standalone ä¹‹åä¼šç”Ÿæˆ /opt/airflow/airflow.cfgÂ æ–‡ä»¶<br/><br/>
airflow standalone é»˜è®¤ä½¿ç”¨ SimpleAuthManager æ–¹å¼éªŒè¯ç”¨æˆ·ï¼Œä»å‰é¢å·²çŸ¥å®ƒä¼šåœ¨å¯åŠ¨æ—¶ç”Ÿæˆ admin çš„å¯†ç ï¼Œè®°å½•åœ¨Â  ${AIRFLOW_HOME}/simple_auth_manager_passwords.json.generated ä¸­ã€‚<br/><br/>
è€å¼çš„Â  <code>airflow users create...</code> å‘½ä»¤å·²ä¸å¯ç”¨ï¼Œé™¤éå®‰è£…äº† apache-airflow-providers-fab<br/><br/>
<blockquote>
pip install apache-airflow-providers-fab
</blockquote>
<br/>
å¹¶ä¸”åœ¨ airflow.cfgÂ ä¸­æŠŠ<br/><br/>
<blockquote>
auth_manager = airflow.api_fastapi.auth.managers.simple.simple_auth_manager.SimpleAuthManager
</blockquote>
<br/>
æ”¹æˆäº†<br/><br/>
<blockquote>
auth_manager = airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
</blockquote>
<br/>
å¦‚æ­¤æ‰èƒ½ç”¨è€çš„æ–¹å¼åˆ›å»ºç”¨æˆ·<br/><br/>
<blockquote>
airflow users create --role Admin --username yanbin --email yabqiu@gmail.com --firstname Yanbin --lastname Qiu --password my-password-123
</blockquote>
<br/>
ä½†ç”¨æˆ·åˆ›å»ºäº†ä¹Ÿæœªå¿…èƒ½é€šè¿‡ç•Œé¢éªŒè¯é€šè¿‡ï¼Œè¿˜ç­‰åœ¨ airflow.cfgÂ ä¸­é…ç½®<br/><br/>
<pre class="lang:default decode:true ">[webserver]
authenticate = True
auth_backend = airflow.www.security.FernetAuthBackend  # or FabAuthBackend</pre>
<br/>
æˆ–è€…ç”¨ç¯å¢ƒå˜é‡<br/><br/>
<pre class="lang:default decode:true ">export AIRFLOW__WEBSERVER__AUTHENTICATE=True
export AIRFLOW__WEBSERVER__AUTH_BACKEND=airflow.www.security.FernetAuthBackend</pre>
<br/>
æ—¢ç„¶ Apache Airflow ä¸å»ºè®®é‚£ä¹ˆä½¿ç”¨ï¼Œè¿˜æ˜¯ç”¨æ–°å‹çš„æ–¹å¼è¿›è¡ŒéªŒè¯å§ï¼Œæ¯”å¦‚é€šè¿‡Â  SSO ç™»é™†ï¼ŒéªŒè¯ JWT token è€Œè¿›å…¥åˆ° Airflow ç­‰ã€‚<br/><br/>
æŒ‡å®š Airflow(webserver çš„ context-path)ï¼Œå¯é…ç½® <code>airflow.cfg</code>,Â åœ¨å…¶ä¸­åŠ ä¸Š<br/><br/>
<pre class="lang:default decode:true">[webserver]
base_url = http://localhost:8080/airflow</pre>
<br/>
æˆ–è€…ç”¨ç¯å¢ƒå˜é‡<br/><br/>
<blockquote>
AIRFLOW__API__BASE_URL=http://localhost:8080/airflow
</blockquote>
<br/>
è¿™é‡Œ base_url é…ç½®ä¸ä¸€å®šéè¦æ˜ç¡®å“ªä¸ª IP åœ°å€ï¼Œç®€å•çš„æŒ‡å®š http://localhost:8080/airflow, æˆ‘ä»¬ä¾ç„¶å¯ä»¥ç”¨å®é™… IP åœ°å€æˆ–åŸŸåè®¿é—®ï¼Œå¦‚ http://192.168.0.100:8080 æ¥è®¿é—®ï¼Œç›¸å½“äºåªè§„å®šçš„ context-path ä¸º /airflowã€‚å› ä¸º Airflow çš„ api-server æœåŠ¡æ˜¯å¯åŠ¨åœ¨ 0.0.0.0:8080 ä¸Šçš„<br/><br/>
<blockquote>
api-server | INFO: Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
</blockquote>
<br/>
å¦‚ä½•ä¸å¯è®¿é—®å°±æ˜ç¡® IP åœ°å€<br/><br/>
<blockquote>
AIRFLOW__API__BASE_URL=http://192.168.0.100:8080/airflow
</blockquote>
<br/>
æˆ–è€…ç›´æ¥é…ç½®ä¸ºæœ€ç»ˆä½¿ç”¨çš„åŸŸåï¼Œå¦‚<br/><br/>
<blockquote>
AIRFLOW__API__BASE_URL=http://example.com/airflow
</blockquote>
<br/>
ä¼¼ä¹ä»ä¸­æˆ‘ä»¬éœ€è¦åªæ˜¯ /airflow è¿™ä¸€éƒ¨åˆ†ã€‚<br/><br/>
è¿™æ ·æ‰ä¾¿äºè¿›è¡Œè´Ÿè½½å‡è¡¡æˆ–åå‘ä»£ç†çš„é…ç½®ï¼Œä¾‹å¦‚è¦åœ¨ Nginx ä¸­é…ç½®è¿”å›ä»£ç†<br/><br/>
<pre class="lang:default decode:true ">server {
    listen 443 ssl;
    server_name example.com;
    ssl_certificate &lt;path-to&gt;/fullchain.cer;
    ssl_certificate_key &lt;path-to&gt;/example.com.key;<br/><br/>
    location / {
        proxy_pass http://192.168.0.2/;
    }<br/><br/>
    location /airflow {
        proxy_pass http://192.168.0.100:8080/airflow/;
    }
}</pre>
<br/>
å¯¹æ‰€æœ‰ /airflow çš„è®¿é—®ä»£ç†åˆ° http://192.168.0.100:8080/airflow, å¦åˆ™ä»£ç†åˆ° http://192.168.0.2/ï¼Œå¦‚æœæœªèƒ½æŒ‡å®š Airflow çš„Â  Context Path, åªæ˜¯é…ç½®<br/><br/>
<pre class="lang:default decode:true">location /airflow {
    proxy_pass http://192.168.0.100:8080/;
}</pre>
<br/>
é‚£ç¬¬ä¸€æ¬¡è®¿é—® http://example.com/airflow æ²¡æœ‰é—®é¢˜ï¼Œä½†ä¸€ç™»é™†å°±å›åˆ°äº† http://example.com/ æˆ–è€… dags çš„ URL æ˜¯ http://example.com/dags, è¿™æ ·å°±æ— æ³•å†é€šè¿‡ /airflow ä¸Šä¸‹æ–‡å›åˆ° /airflow -&gt; http://192.168.0.100:8080 äº†.<br/><br/>
ä¸ç”¨ context-path, å‰ç«¯ä½¿ç”¨äº† nginx ä½œåå‘ä»£ç†çš„è¯ï¼Œå¦‚æœå“åº”ä¸­æœ‰ç»å¯¹çš„è·¯å¾„è¡¨ç¤ºæ³•ï¼Œå¦‚<br/><br/>
<blockquote>
&lt;img src="/abc.img"/&gt;<br />
&lt;a href="/xyz.html/&gt;
</blockquote>
<br/>
å°±éœ€è¦ç”¨ sub_filter å»æ›¿æ¢ï¼Œè‚¯å®šä¼šå½±å“ä¸€äº›æ€§èƒ½<br/><br/>
<pre class="lang:default mark:3 decode:true">location /airflow {
    proxy_pass http://192.168.0.100:8080/
    sub_filter '&lt;a href="/' '&lt;a href="/airflow';
    sub_filter '&lt;img src="/' '&lt;img src"/airflow';
    sub_filter_once off;
}</pre>
<br/>
sub_filter éœ€è¦ç”¨æ­£åˆ™è¡¨è¾¾å¼è€ƒè™‘åˆ°æ‰€æœ‰æƒ…å†µï¼Œä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼ï¼Œæ ‡ç­¾å±æ€§çš„é¡ºåºç­‰ï¼Œæ‰€ä»¥æœ€å¥½æ˜¯è¦ç”¨ context-path, æˆ–è€…ç”¨å­åŸŸåæ›´ä¼˜ã€‚<br/><br/>
æœ€åï¼Œè¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæœ€å¿«é€Ÿçš„åŠæ³•å°±æ˜¯ docker-compose exec -it airflow bash è¿›åˆ°å®¹å™¨ä¸­å»æŸ¥ï¼Œæ¯”å¦‚ç”¨ envÂ  å‘½ä»¤çœ‹çœ‹ç¯å¢ƒå˜é‡æ˜¯å¦è®¾ç½®å¾—å½“ï¼Œå·æ˜ å°„æ˜¯å¦æˆåŠŸã€‚<br/><br/>
é“¾æ¥ï¼š<br/><br/>
<ol>
    <li><a href="https://blog.csdn.net/jiabeis/article/details/100974516">nginxåå‘ä»£ç†æœåŠ¡contextpathçš„é—®é¢˜è§£å†³</a></li>
</ol>
