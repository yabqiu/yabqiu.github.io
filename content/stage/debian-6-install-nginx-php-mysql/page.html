---
title: Debian 6 上安装 Nginx+PHP+MySQL
url: /debian-6-install-nginx-php-mysql/
date: 2014-02-14T20:06:51-06:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
categories:
  - Linux/Unix
  - PHP
tags: 
  - Linux
  - php
  - Mysql
  - Debian
comment: true
codeMaxLines: 50
# additional
wpPostId: 6202 
wpStatus: publish
views: 753
lastmod: 2014-02-14T20:06:51-06:00
---

正在使用亚马逊的 VPS，一年的小心翼翼的免费期，选择的是 Debian 6 32 位的系统，因搭建 WordPress 试图在上面安装 Nginx+PHP 的环境。看着在 Nginx 环境下多是使用 php-fpm，而不是 php-cgi，前者与后者的区别是在孤立的 php-cgi 之上又多了一个调度层。<br/>
<br/>
一开始打算一步步纯手工打造，但在执行&nbsp;<code>apt-get install php-fpm</code> 时总有不可逾越的依赖症，所以转而寻求更傻瓜的一键包安装方式。试过 <a href="http://lnmp.org/" target="_blank">LNMP</a>，包太大，东西太过于齐全，把人太当傻瓜，虽然如此，我在用它安装时也有些慢，因为它也是采取的编译安装方式，针对本机应该有很好的优化。没装完我就中断了，下次有时间可以再试下。<br/>
<br/>
正好在这期间看到了 Dvid Pennington 制作的 <a href="https://github.com/Xeoncross/lowendscript" target="_blank">lowendscript lnmp</a> 一键安装脚本，很省事，连安装&nbsp; WordPress 也考虑到了，这里有介绍，比较详细 <a href="http://my.oschina.net/u/1448992/blog/198429" target="_blank">lowendscript:最省资源lnmp一键包</a>。我只记录下我自己的安装过程，以备忘。<!--more--><br/>
<br/>
1. 下载 lowendscript 安装脚本<br/>
<blockquote>wget --no-check-certificate https://raw.github.com/Xeoncross/lowendscript/master/setup-debian.sh</blockquote>

2. 添加可执行权限<br/>
<blockquote>chmod +x setup-debian.sh</blockquote>

3. 添加 dotdeb 源<br/>
<blockquote>sudo ./setup-debian.sh dotdeb</blockquote>

4. 系统准备<br/>
<blockquote>sudo ./setup-debian.sh system</blockquote>

5. 安装 php，会告诉你怎么起停 php-fpm, sudo /etc/init.d/php5-fpm restart<br/>
<blockquote>sudo ./setup-debian.sh php</blockquote>

6. 安装 Nginx (1.4+), 起停 nginx&nbsp; 用 sudo /etc/init.d/nginx restart<br/>
<blockquote>sudo ./setup-debian.sh nginx</blockquote>

7. 安装 MySQL，/root/.my.cnf 中看管理员帐户和密码<br/>
<blockquote>sudo ./setup-debian.sh mysql</blockquote>

8. 指定域名建立站点<br/>
<blockquote>sudo ./setup-debian.sh site</blockquote>

还能帮你自动搭建 WordPress 站点，用命令 <code>sudo ./setup-debian.sh wordpress [domain]</code>，另外 setup-debian.sh 命令还为我们提供了很多工具的便捷安装，运行 sudo ./setup-debian.sh --help 看帮助内容：<br/>
<blockquote>Usage: setup-debian.sh [option] [argument]<br/>
Available options (in recomended order):<br/>
&nbsp; - dotdeb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (install dotdeb apt source for nginx 1.2+)<br/>
&nbsp; - system&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (remove unneeded, upgrade system, install software)<br/>
&nbsp; - dropbear&nbsp; [port]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (SSH server)<br/>
&nbsp; - iptables&nbsp; [port]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (setup basic firewall with HTTP(S) open)<br/>
&nbsp; - mysql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (install MySQL and set root password)<br/>
&nbsp; - nginx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (install nginx and create sample PHP vhosts)<br/>
&nbsp; - php&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (install PHP5-FPM with APC, cURL, suhosin, etc...)<br/>
&nbsp; - exim4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (install exim4 mail server)<br/>
&nbsp; - site&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [domain.tld] (create nginx vhost and /var/www/$site/public)<br/>
&nbsp; - mysqluser [domain.tld] (create matching mysql user and database)<br/>
&nbsp; - wordpress [domain.tld] (create nginx vhost and /var/www/$wordpress/public)<br/>
&nbsp;<br/>
... and now some extras<br/>
&nbsp; - info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Displays information about the OS, ARCH and VERSION)<br/>
&nbsp; - sshkey&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Generate SSH key)<br/>
&nbsp; - apt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (update sources.list for UBUNTU only)<br/>
&nbsp; - ps_mem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Download the handy python script to report memory usage)<br/>
&nbsp; - vzfree&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Install vzfree for correct memory reporting on OpenVZ VPS)<br/>
&nbsp; - motd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Configures and enables the default MOTD)<br/>
&nbsp; - locale&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Fix locales issue with OpenVZ Ubuntu templates)<br/>
&nbsp; - webmin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Install Webmin for VPS management)<br/>
&nbsp; - test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Run the classic disk IO and classic cachefly network test)<br/>
&nbsp; - 3proxy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (Install 3proxy - Free tiny proxy server, with authentication support, HTTP, SOCKS5 and whatever you can throw at it)<br/>
&nbsp; - 3proxyauth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (add users/passwords to your proxy user authentication list)</blockquote>

在站点目录中建个 phpinfo.php&nbsp; 文件来测试一下吧，可以看看 php.ini 文件的位置，已启用了哪些 php 组件等。<br/>
默认情况下 Nginx&nbsp; 中处理 php 时是通过 http://127.0.0.1:9000 与 php-cgi 通信的，我们可以改成借助于 sock 文件来建立关联的，修改 php-fpm.conf 文件把 listen 设置为 <code>/var/run/php5-fpm.sock</code>。然后改 /etc/nginx/php.conf 中的&nbsp;<code>fastcgi_pass 127.0.0.1:9000</code> 为 <code>fastcgi_pass unix:/var/run/php5-fpm.sock</code>.<br/>
<br/>
如果你在访问 php 时看到 502 Bad Gateway, 原因就是 php 没法请求给 php-cgi 进行处理，有错误别忘了查看&nbsp; error.log，可能里面有写到类似这样的内容<br/>
<br/>
2014/02/12 04:07:31 [error] 20160#0: *1 connect() failed (111: Connection refused) while connecting to upstream, client: 184.75.196.2, server: <span style="text-decoration: underline;">unmi.cc</span>, request: "GET /phpinfo.php HTTP/1.1", upstream: "fastcgi://127.0.0.1:9000", host: “<span style="text-decoration: underline;">unmi.cc</span>"<br/>
<br/>
这时你可以看看 9000 端口是否起来了。<br/>
<br/>
再就是默认情况下 php 的可能有些你要用到的组件没被安装，一个个处理就行，比如要装下面这些<br/>
<blockquote>sudo apt-get install php5-curl php5-gd php5-mysql</blockquote>

安装 PHP 组件后后 php5-fpm 会自动重启，这就是 php-fpm (PHP - FastCGI Process Manager) 的一个好处。<br/>
<br/>
本人的体验，也不知道是哪儿出错了，反正搭建起来的 WordPress 是能用了，刚开始也挺快的，可以没多久 PHP 网页就很难打开，重启 Nginx, PHP-FPM，甚至是操作系统也是短暂时的解决问题，不过几分钟又假死了，原因应该是 PHP-FPM 在处理 php 脚本没响应了。看看不行我又装回了熟悉的 Apache2 了，有机会再去搬弄 Ngnix+PHP 的是非吧。<br/>
<br/>
链接：1. <a href="http://my.oschina.net/leejun2005/blog/85749" target="_blank">什么是CGI、FastCGI、PHP-CGI、PHP-FPM、Spawn-FCGI？</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2. <a href="https://library.linode.com/web-servers/nginx/php-fastcgi/debian-6-squeeze" target="_blank">Nginx and PHP-FastCGI on Debian 6 (Squeeze)</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3. <a href="http://my.oschina.net/u/1448992/blog/198429" target="_blank">lowendscript:最省资源lnmp一键包</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4. <a href="http://www.koryi.net/net/739.html" target="_blank">Debian 源安装 NGINX+PHP+MYSQL</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 5. <a href="http://www.nonozone.net/debian-install-nginx-php-fpm-mysql-phpmyadmin-memo.html" target="_blank">Debian安装Nginx+php-fpm+mysql+phpmyadmin备忘</a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6. <a href="http://www.5ilinux.com/2011/04/debian6lemp01.html" target="_blank">Debian 6(Squeeze)安装 Nginx + PHP5 + PHP-FPM + MySQL(一)<br/>
</a>
