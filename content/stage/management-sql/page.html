---
title: "管理常用SQL语句 [转]"
url: /management-sql/
date: 2006-09-18T11:39:00-05:00
featured: false
draft: true
toc: false
# menu: main
usePageBundles: true
categories:
  - Database
tags: 
  - database
  - Sql
comment: true
codeMaxLines: 50
# additional
wpPostId: 544 
wpStatus: publish
views: 370
lastmod: 2010-08-28T05:49:47-05:00
---

　　<strong>1. 查看数据库的版本</strong>       <br/>
　　 select @@version<br/>
<br/>
　　<strong>2. 查看数据库所在机器操作系统参数</strong>       <br/>
<br/>
　　exec master..xp_msver<br/>
　　<strong>3. 查看数据库启动的参数</strong>        <br/>
<br/>
　　sp_configure <!--more--><br/>
　　<strong>4. 查看数据库启动时间</strong>        <br/>
<br/>
　　select convert(varchar(30),login_time,120) from master..sysprocesses where spid=1<br/>
<br/>
　　查看数据库服务器名和实例名<br/>
<br/>
　　print 'Server Name...............：' + convert(varchar(30),@@SERVERNAME)        <br/>
<br/>
　　print 'Instance..................：' + convert(varchar(30),@@SERVICENAME)  <br/>
       <br/>
　　<strong>5. 查看所有数据库名称及大小</strong>    <br/>
<br/>
　　sp_helpdb<br/>
<br/>
　　重命名数据库用的SQL<br/>
<br/>
　　sp_renamedb 'old_dbname', 'new_dbname'<br/>
　　<strong>6. 查看所有数据库用户登录信息</strong>    <br/>
<br/>
　　sp_helplogins<br/>
<br/>
　　查看所有数据库用户所属的角色信息       <br/>
<br/>
　　sp_helpsrvrolemember<br/>
<br/>
　　修复迁移服务器时孤立用户时,可以用的fix_orphan_user脚本或者LoneUser过程<br/>
<br/>
　　更改某个数据对象的用户属主<br/>
　　<br/>
　　sp_changeobjectowner [@objectname =] 'object', [@newowner =] 'owner'<br/>
<br/>
　　注意：更改对象名的任一部分都可能破坏脚本和存储过程。<br/>
<br/>
　　把一台服务器上的数据库用户登录信息备份出来可以用add_login_to_aserver脚本<br/>
<br/>
　　查看某数据库下,对象级用户权限<br/>
<br/>
　　sp_helprotect<br/>
　　<strong>7. 查看链接服务器</strong>           <br/>
　　<br/>
　　sp_helplinkedsrvlogin<br/>
<br/>
　　查看远端数据库用户登录信息<br/>
<br/>
　　sp_helpremotelogin<br/>
　　<strong>8.查看某数据库下某个数据对象的大小</strong><br/>
<br/>
　　sp_spaceused @objname<br/>
<br/>
　　还可以用sp_toptables过程看最大的N(默认为50)个表<br/>
<br/>
　　查看某数据库下某个数据对象的索引信息<br/>
<br/>
　　sp_helpindex @objname<br/>
<br/>
　　还可以用SP_NChelpindex过程查看更详细的索引情况<br/>
<br/>
　　SP_NChelpindex @objname<br/>
<br/>
　　clustered索引是把记录按物理顺序排列的，索引占的空间比较少。 <br/>
<br/>
　　对键值DML操作十分频繁的表我建议用非clustered索引和约束，fillfactor参数都用默认值。<br/>
<br/>
　　查看某数据库下某个数据对象的的约束信息<br/>
<br/>
　　sp_helpconstraint @objname<br/>
<br/>
　　<strong>9.查看数据库里所有的存储过程和函数</strong><br/>
<br/>
　　use @database_name<br/>
<br/>
　　sp_stored_procedures<br/>
<br/>
　　查看存储过程和函数的源代码<br/>
<br/>
　　sp_helptext <a href="mailto:%27@procedure_name%27">mailto:%27@procedure_name%27</a><br/>
<br/>
　　查看包含某个字符串@str的数据对象名称<br/>
<br/>
　　select distinct object_name(id) from syscomments where text like <a href="mailto:%27%@str%%27">mailto:%27%@str%%27</a><br/>
<br/>
　　创建加密的存储过程或函数在AS前面加WITH ENCRYPTION参数<br/>
<br/>
　　解密加密过的存储过程和函数可以用sp_decrypt过程<br/>
　　<strong>10.查看数据库里用户和进程的信息</strong><br/>
<br/>
　　sp_who<br/>
<br/>
　　查看SQL Server数据库里的活动用户和进程的信息<br/>
<br/>
　　sp_who 'active'<br/>
<br/>
　　查看SQL Server数据库里的锁的情况<br/>
<br/>
　　sp_lock<br/>
<br/>
　　进程号1--50是SQL Server系统内部用的,进程号大于50的才是用户的连接进程.<br/>
　　<br/>
　　spid是进程编号,dbid是数据库编号,objid是数据对象编号<br/>
<br/>
　　查看进程正在执行的SQL语句<br/>
<br/>
　　dbcc inputbuffer ()<br/>
<br/>
　　推荐大家用经过改进后的sp_who3过程可以直接看到进程运行的SQL语句<br/>
<br/>
　　sp_who3<br/>
<br/>
　　检查死锁用sp_who_lock过程<br/>
<br/>
　　sp_who_lock<br/>
              <br/>
　　<br/>
　　<strong>11.查看和收缩数据库日志文件的方法</strong><br/>
<br/>
　　查看所有数据库日志文件大小          <br/>
<br/>
　　dbcc sqlperf(logspace)<br/>
<br/>
　　如果某些日志文件较大，收缩简单恢复模式数据库日志，收缩后@database_name_log的大小单位为M<br/>
<br/>
　　backup log @database_name with no_log<br/>
<br/>
　　dbcc shrinkfile (@database_name_log, 5)<br/>
　　<strong>12.分析SQL Server SQL 语句的方法：</strong><br/>
<br/>
　　set statistics time {on | off}<br/>
<br/>
　　set statistics io {on | off}<br/>
<br/>
　　图形方式显示查询执行计划<br/>
<br/>
　　在查询分析器-&gt;查询-&gt;显示估计的评估计划(D)-Ctrl-L    或者点击工具栏里的图形<br/>
<br/>
　　文本方式显示查询执行计划<br/>
<br/>
　　set showplan_all {on | off}<br/>
<br/>
　　set showplan_text { on | off }<br/>
<br/>
　　set statistics profile { on | off }<br/>
　　<strong>13.出现不一致错误时，NT事件查看器里出3624号错误，修复数据库的方法</strong><br/>
　　先注释掉应用程序里引用的出现不一致性错误的表，然后在备份或其它机器上先恢复然后做修复操作<br/>
<br/>
　　alter database [@error_database_name] set single_user<br/>
<br/>
　　修复出现不一致错误的表<br/>
<br/>
　　dbcc checktable(<a href="mailto:%27@error_table_name%27,repair_allow_data_loss">mailto:%27@error_table_name%27,repair_allow_data_loss</a>)<br/>
<br/>
　　或者可惜选择修复出现不一致错误的小型数据库名<br/>
<br/>
　　dbcc checkdb(<a href="mailto:%27@error_database_name%27,repair_allow_data_loss">mailto:%27@error_database_name%27,repair_allow_data_loss</a>)<br/>
<br/>
　　alter database [@error_database_name] set multi_user<br/>
<br/>
　　CHECKDB 有3个参数：<br/>
<br/>
　　repair_allow_data_loss 包括对行和页进行分配和取消分配以改正分配错误、结构行或页的错误，以及删除已损坏的文本对象，这些修复可能会导致一些数据丢失。<br/>
<br/>
　　修复操作可以在用户事务下完成以允许用户回滚所做的更改。<br/>
<br/>
　　如果回滚修复，则数据库仍会含有错误，应该从备份进行恢复。<br/>
<br/>
　　如果由于所提供修复等级的缘故遗漏某个错误的修复，则将遗漏任何取决于该修复的修复。<br/>
<br/>
　　修复完成后，请备份数据库。 <br/>
<br/>
　　repai*_**st 进行小的、不耗时的修复操作，如修复非聚集索引中的附加键。<br/>
<br/>
　　这些修复可以很快完成，并且不会有丢失数据的危险。 <br/>
<br/>
　　repair_rebuild 执行由 repai*_**st 完成的所有修复，包括需要较长时间的修复（如重建索引）。<br/>
<br/>
　　执行这些修复时不会有丢失数据的危险。
