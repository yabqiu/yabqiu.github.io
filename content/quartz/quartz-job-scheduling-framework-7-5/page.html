---
title: Quartz Job Scheduling Framework［翻译］第七章. 实现 Quartz 监听器 (第五部分)
url: /quartz-job-scheduling-framework-7-5/
date: 2008-07-09T23:28:00-05:00
featured: false
draft: false
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/quartz-logo.jpeg"
categories:
  - Quartz
tags: 
  - Quartz
  - 翻译
comment: true
codeMaxLines: 50
# additional
wpPostId: 372 
wpStatus: publish
views: 665
lastmod: 2020-03-22T12:11:01-05:00
---

<strong>六. 使用 <span style="color: #800080;">FileScanListener</span><br />
</strong></p>
<br/>
Quartz 框架还包含一个我们未曾提及的监听器。这个监听器不像别的，因为它是为特定目的而设计的：同框架所带的一个工具 Job 一起用的。<br/><br/>
这个监听器就是 <span style="color: #800080;">org.quartz.jobs.FileScanListener</span> 接口，它显式的设计为 <span style="color: #800080;">FileScanJob</span> 所用的，这一 Job 也在 <span style="color: #800080;">org.quartz.jobs</span> 包中。<span style="color: #800080;">FileScanJob</span> 检查某一指定文件的 <span style="color: #800080;">lastModifiedDate</span>。当某人改变了这个文件，这个 Job 就调用 <span style="color: #800080;">FileScanListener</span> 的 <span style="color: #800080;">fileUpdated()</span> 方法。<br/><br/>
就像使用其他类型的 Quartz 监听器一样，你必须创建一个实现了 <span style="color: #800080;">FileScanListener</span> 接口的具体类。只有一个方法需要实现：<!--more--><br/><br/>
<span style="color: #800080;">public void fileUpdated(String fileName);<br />
</span><br />
代码  7.12 展了了我们的一个极简单的 <span style="color: #800080;">FileScanListener</span> 实现。<br/><br/>
<strong>代码 7.12. 一个简单的 <span style="color: #800080;">FileScanListener</span> 实现<br />
</strong>
{{< highlight java >}}
package org.cavaness.quartzbook.chapter7;

import java.io.File;
import java.sql.Timestamp;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class SimpleFileScanListener implements org.quartz.jobs.FileScanListener {
     private static Log logger = LogFactory.getLog(SimpleFileScanListener.class);

     public void fileUpdated(String fileName) {
          File file = new File(fileName);
          Timestamp modified = new Timestamp(file.lastModified());

          logger.info( fileName + " was changed at " + modified );
     }
}
{{</ highlight >}}
<br/>
显然，你会想做些更有意义的事情，而不仅仅是写下一条日志信息，但是你从代码 7.12 中的简单例子中明白了要旨。我们也必须在部署 <span style="color: #800080;">FileScanJob</span> 时为它使用这一新型监听器。代码 7.13 展示了如何部署 <span style="color: #800080;">FileScanJob</span>。<br/><br/>
<strong>代码 7.13. 部署 <span style="color: #800080;">FileScanJob</span></strong>
{{< highlight java >}}
package org.cavaness.quartzbook.chapter7;

import java.util.Date;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.quartz.JobDataMap;
import org.quartz.JobDetail;
import org.quartz.Scheduler;
import org.quartz.SchedulerException;
import org.quartz.Trigger;
import org.quartz.TriggerUtils;
import org.quartz.impl.StdSchedulerFactory;
import org.quartz.jobs.FileScanJob;

public class Listing_7_13 {
     private static Log logger = LogFactory.getLog(Listing_7_13.class);

     public static void main(String[] args) {
          Listing_7_13 example = new Listing_7_13();

          try {
               Scheduler scheduler = example.createScheduler();
               example.scheduleJob(scheduler);
               scheduler.start();

          } catch (SchedulerException ex) {
               logger.error(ex);
          }
    }

    protected Scheduler createScheduler() throws
         SchedulerException {

         return StdSchedulerFactory.getDefaultScheduler();
    }

    protected void scheduleJob(Scheduler scheduler) throws
         SchedulerException {

         // Store the FileScanListener instance
         scheduler.getContext().put("SimpleFileScanListener",
                   new SimpleFileScanListener());

         // Create a JobDetail for the FileScanJob
         JobDetail jobDetail = new JobDetail("FileScanJob", null,
                   FileScanJob.class);

         // The FileScanJob needs some parameters
         JobDataMap jobDataMap = new JobDataMap();
         jobDataMap.put(FileScanJob.FILE_NAME,
                   "C:\\quartz-book\\input1\\test.txt");
         jobDataMap.put(FileScanJob.FILE_SCAN_LISTENER_NAME,
                   "SimpleFileScanListener");
         jobDetail.setJobDataMap(jobDataMap);

         // Create a Trigger and register the Job
         Trigger trigger = TriggerUtils.makeSecondlyTrigger(30);
         trigger.setName("SimpleTrigger");
         trigger.setStartTime(new Date());

         scheduler.scheduleJob(jobDetail, trigger);
    }
}
{{</ highlight >}}
<br/>
代码 7.13 中的程序像几乎所有别的 必须部署一个 Job 的 Quartz  应用。<span style="color: #800080;">FileScanJob</span> 需要两个参数：要监视文件的 <span style="color: #800080;">FILE_NAME</span>，和 <span style="color: #800080;">FileScanListener(FILE_SCAN_LISTENER_NAME)</span> 的名称。这两个参数的值会存在 <span style="color: #800080;">JobDataMap</span> 中，因此 <span style="color: #800080;">FileScanJob</span> 能访问到它们。<br/><br/>
仅有一个特别要注意，容易出错的地方就是要确保添加了一个 <span style="color: #800080;">FileScanListener</span> 到 <span style="color: #800080;">SchedulerContext</span> 中。这在代码 7.13 中是通过如下代码片断完成的：<br/><br/>
<span style="color: #800080;">scheduler.getContext().put("SimpleFileScanListener",<br />
     new SimpleFileScanListener());<br />
</span><br />
这一步是必须的，因为 <span style="color: #800080;">FileScanJob</span> 获取到 <span style="color: #800080;">SchedulerContext</span> 的引用，然后使用设置到 <span style="color: #800080;">JobDataMap</span> 中的名称找寻 <span style="color: #800080;">FileScanListener</span>。<br/><br/>
<span style="color: #800080;">jobDataMap.put(FileScanJob.FILE_SCAN_LISTENER_NAME,<br />
     "SimpleFileScanListener");<br />
</span><br />
如果你还有所困惑，别担心：看一看 <span style="color: #800080;">org.quartz.jobs.FileScanJob</span> 类的源代码吧。这是对待开源软件最好的方式了。
