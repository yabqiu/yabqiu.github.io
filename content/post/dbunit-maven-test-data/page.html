---
title: 用 dbunit-maven-plugin 来管理你的测试数据
url: /dbunit-maven-test-data/
date: 2010-10-23T02:14:43-05:00
featured: false
draft: false
toc: false
# menu: main
usePageBundles: true
categories:
  - Java/JEE
tags: 
  - Maven
  - dbunit
comment: true
codeMaxLines: 50
# additional
wpPostId: 2811 
wpStatus: publish
views: 1847
lastmod: 2021-09-04T11:07:52-05:00
---

单元测试有人写过，也有人没做过，数据库的 dbunit 的用的人应该更少了，它可以用来给你做测试准备数据。一般我们做测试会在一个测试数据库中不停的测，自然会累积许多垃圾数据，给单元测试会造成不便，功能测试倒无太紧要。如果我们想在单元测试的时候有一份干净的数据，有个做法是搞个备用的数据库，测试前导到测试库的，或用某些数据库的导入导出功能。</p>
<br/>
这里我们来看 dbunit 怎么实现准备测试数据的，它可以用来导出数据库数据到数据文件中，从数据文件中导入干净的数据到数据库中，比较数据库与数据文件、或增量的插入记录等等。<!--more--><br/><br/>
dbunit 最初为 ant 提供了 antask，当然可以编程使用，如今 maven 大行其道，所以也就有了 maven 的 dbunit 插件，相似功能的插件有两个：<br/><br/>
1. <a href="http://mojo.codehaus.org/dbunit-maven-plugin" target="_blank" rel="noopener">dbunit-maven-plugin</a><br />
2. <a href="http://maven-plugins.sourceforge.net/" target="_blank" rel="noopener">maven-dbunit-plugin</a><br/><br/>
就是 maven 和 dbunit 倒了一下，别晕了，第二个似乎提供了更多的 goal，但运行 mvn dbunit:xxxx，指向的是第一个 dbunit-maven-plugin，看来第一个要正统些。本文也就介绍下 <a href="http://mojo.codehaus.org/dbunit-maven-plugin" target="_blank" rel="noopener">dbunit-maven-plugin</a> 的用法，测试数据库是 MySql。<br/>
看我们的 pom.xml 文件：<br/>
{{< highlight xml >}}
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <groupId>cc.unmi</groupId>
    <artifactId>testdbunit</artifactId>
    <name>TestDbuni</name>
    <version>0.0.1-SNAPSHOT</version>
    <build>
        <plugins>
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>dbunit-maven-plugin</artifactId>
                <version>1.0-beta-3</version>
                <configuration>
                    <driver>com.mysql.jdbc.Driver</driver>
                    <url>jdbc:mysql://localhost/wptest?zeroDateTimeBehavior=convertToNull</url>
                    <username>root</username>
                    <password></password>
                    <dataTypeFactoryName>org.dbunit.ext.mysql.MySqlDataTypeFactory</dataTypeFactoryName>
                    <metadataHandlerName>org.dbunit.ext.mysql.MySqlMetadataHandler</metadataHandlerName>
                    <encoding>utf-8</encoding>
                    <src>target/dbunit/export.xml</src><!--compare 和 operation 要用到它 -->
                    <type>CLEAN_INSERT</type><!--operation 要用到它-->
                </configuration><br/><br/>
                <dependencies>
                    <dependency>
                        <groupId>mysql</groupId>
                        <artifactId>mysql-connector-java</artifactId>
                        <version>5.1.13</version>
                    </dependency>
                </dependencies>
            </plugin>
        </plugins>
    </build>
</project>
{{</ highlight >}}
<br/>
dbunit-maven-plugin 有四个 goal，分别是：<br/><br/>
<a href="http://mojo.codehaus.org/dbunit-maven-plugin/compare-mojo.html" target="_blank" rel="noopener">dbunit:compare</a> 比较数据库与数据文件中的内容，相同则提示成功，不同则报异常<br />
<a href="http://mojo.codehaus.org/dbunit-maven-plugin/export-mojo.html" target="_blank" rel="noopener">dbunit:export</a> 导出数据库内容到数据文件中，默认是 xml 格式的数据<br />
<a href="http://mojo.codehaus.org/dbunit-maven-plugin/help-mojo.html" target="_blank" rel="noopener">dbunit:help</a> 看帮助的，要看 goal 的更详细的帮助可用：mvn dbunit:help -Ddetail=true -Dgoal=&lt;goal-name&gt;<br />
<a href="http://mojo.codehaus.org/dbunit-maven-plugin/operation-mojo.html" target="_blank" rel="noopener">dbunit:operation</a> 可用来执行数据库操作，如 插入、清除数据，清除并插件数据等。用的多的应该是 CLEAN_INSERT，可得到一份干净的数据库。<br/><br/>
上面的 pom.xml 是一个基本的配置，未指定的会使用默认值，例如导出数据的目的地是 <span style="color: #993300;">&lt;dest&gt;target/dbunit/export.xml&lt;/dest&gt;</span>，点击每个 goal 的链接可以看到可以加到 &lt;configuration&gt; 节点中更多的配置项。<br/><br/>
好了，现在有了 pom.xml 文件就可以用来执行相应的 goal 了，在命令行下进到这个 pom.xml 所在的目录中：<br/><br/>
执行 mvn dbunit:export 你会看到生成了一个 target/dbunit/export.xml，包含了库中所有表的数据。<br/><br/>
执行 mvn dbunit:compare 会将 &lt;src&gt; 指定的数据文件与数据库内容对比，相同则提示成功，不同就会报异常，由于我们上面指定的源文件是刚刚导出的 target/dbunit/export.xml，所以比较是成功的。<br/><br/>
现在把数据库清空掉，然后执行 mvn dbunit:operation 后，你会发现数据库中的内容又原来的一样，是因为这个命令把数据文件 &lt;src&gt; 指示的 target/dbunit/export.xml 的数据导入到了数据库中。其实在执行 CLEAN_INSERT 时会先把数据库中的数据清理掉的。<br/><br/>
dbunit:operation goal 的 type 取值有：UPDATE, INSERT, DELETE, DELETE_ALL, REFRESH, CLEAN_INSERT, MSSQL_INSERT, MSSQL_REFRESH, MSSQL_CLEAN_INSERT，你可以尝试一下其他值产生的效果，有些很容易理解用途的。<br/><br/>
可能出现的异常，比如当执行 mvn dbunit:export 有 ERROR 时，请加上 -e 参数执行，mvn dbunit:export -e (要是执行 mvn dbunit:export -X 会有更多的信息)你将会看到详细的异常栈。例如碰到：<br/><br/>
<span style="color: #993300;">Caused by: java.lang.ClassNotFoundException: com.mysql.jdbc.Driver</span><br/><br/>
就应该知道是驱动没找到，只要加到对 MySql 驱动的依赖就行。<br/><br/>
你要是看到:<br/><br/>
<span style="color: #993300;">Caused by: java.sql.SQLException: Cannot convert value '0000-00-00 00:00:00' from column 8 to TIMESTAMP.</span><br/><br/>
<span style="color: #993300;">Caused by: java.sql.SQLException: Value '[B@297ffb' can not be represented as java.sql.Timestamp</span><br/><br/>
这样的错误，那要请为你的 MySql jdbc 链接字符串加上属 zeroDateTimeBehavior=convertToNull。关于 MySql 的属性请参考文章下端列出的链接。<br/><br/>
然而，有时候我们并不会直接去呼叫 dbunit:export 这样的 goal，我们会在某个 phase 之后来执行这个 goal，以 dbunit:export 为例，那就要在 pom.xml 中的 dbunit-maven-plugin 插件配置中加上：<br/>
{{< highlight xml >}}
<executions>
    <execution>
        <phase>process-test-classes</phase>
        <goals>
            <goal>operation</goal>
        </goals>
        <!-- specific configurations 我们可以在这里指定不同的配置-->
        <configuration>
            <format>xml</format>
            <src>src/export.xml</src>
            <type>CLEAN_INSERT</type>
        </configuration>
    </execution>
</executions>
{{</ highlight >}}
<br/>
因为 phase 也是按顺序执行的，这里设置的 goal 是 process-test-classes，所以当我们在执行 mvn process-test-classes 后会调用这个 dbunit:operation goal。而当我们执行 mvn test 时，会发现这个 dbunit:operation 会在 test 之前执行，这能也就能为我们准备好单元测试的数据了，不会因为小动了下数据库而让 test 全线告错。<br/><br/>
对于另外两个 goal，dbunit:compare 和 dbunit:export 也可以采用类似的配置，让某个 phase 来调用。<br/><br/>
最后，留意下每个 goal 的所有配置以及相应的默认值，比如在执行 dbunit:export 时可以用 &lt;schema&gt; 指定导出哪些表，再严格点可以用<br/>
{{< highlight xml >}}
<tables>
    <table>
        <name>wp_users</name>
        <name>wp_posts</name>
    </table>
</tables>
{{</ highlight >}}
<br/>
指定导出某些特定的表。<br/><br/>
参考：1. <a href="http://gavin-chen.javaeye.com/blog/336607" target="_blank" rel="noopener">Maven plugin中的lifecycle、phase、goal、mojo概念及作用的理解</a><br />
             2. <a href="http://maven.apache.org/guides/plugin/guide-java-plugin-development.html" target="_blank" rel="noopener">Guide to Developing Java Plugins</a><br />
             3. <a href="http://dev.mysql.com/doc/refman/5.1/en/connector-j-reference-configuration-properties.html" target="_blank" rel="noopener">Driver/Datasource Class Names, URL Syntax and Configuration Properties for Connector/J</a>
