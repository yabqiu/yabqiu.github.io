---
title: Chrome 扩展开发，定制多功能框(omnibox)
url: /chrome-extensions-development-omnibox/
date: 2014-04-29T02:05:41-05:00
featured: false
draft: false
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/chrome-logo.png"
categories:
  - Web/JS
tags: 
  - plugin
  - Chrome
comment: true
codeMaxLines: 50
# additional
wpPostId: 6419 
wpStatus: publish
views: 975
lastmod: 2021-09-03T18:17:36-05:00
---

原来一直想着用完整的 Web 应用或 GUI 来做些增强效率的工具集，其实我们每天打交道的浏览器，进行下扩展就能好好的利用。粗略对比了下 Chrome 和 Firefox 的插件系统，Chrome 的插件开发应该要比 Firefox 的简单，无需引用什么新的概念，像 XUL。</p>
<br/>
例如，想实现一下 omnibox，即 Chrome 的全功能框(地址栏)，想要地址栏进入自定的 Unmi 模式，输入关键字让 google 去本站查询，或是输入 tag, category 直接进入本站的相关 tag, category 日志列表，在当前浏览器的 Tab 中打开目的页面。<br/><br/>
比如在地址栏上输入关键字 "u&gt;", 然后按空格或 Tab 键就进入到 Unmi 模式，如图<br/><br/>
{{< bundle-image src="unmi_omnibox.png" width="500px" >}}
下面是完整开发步骤<!--more--><br/><br/>
1. 建立一个目录，如 unmi, 这样 Chrome 开发模式下才好从这个目录中加载插件<br/><br/>
2. 每个 Chrome 插件都有的清单文件 manifest.json，这里的内容是<br/>
{{< highlight json >}}
{
    "manifest_version": 2,
    "name": "Unmi",
    "version": "0.9",
    "omnibox": {
        "keyword": "u>"  //地址栏输入 u> 空格或 Tab 进入本模式
    },
    "permissions": [
        "tabs",
        "http://*/*"
    ],
    "icons": {  //可选，没有话，Chrome 会使用默认的图标
        "16": "unmi_16x16.png" //需准备好这个文件
    },
    "background": {
        "persistent": false,
        "scripts": ["background.js"] //程序就写在这里面
    }
}
{{</ highlight >}}
<br/>
manifest.json 的帮助请看 <a href="https://developer.chrome.com/extensions/manifest" target="_blank" rel="noopener">Manifest File Format</a> 页面。上面是本项目的基本配置，配说明。<br/><br/>
3. 实现 background.js，相关 API 说明见 <a href="https://developer.chrome.com/extensions/omnibox" target="_blank" rel="noopener">chrome.omnibox</a><br/>
{{< highlight js >}}
chrome.omnibox.setDefaultSuggestion({description: "search articles in site unmi.cc"});

chrome.omnibox.onInputChanged.addListener(
  function(text, suggest) {
    suggest([
      {content: "tag="+text, description: "list articles associated with tag " + text}, 
      {content: "category="+text, description: "list articles associated with category " + text}
    ]);
  });

chrome.omnibox.onInputEntered.addListener(function(text) {

  var url;
  if(text.indexOf("tag=") == 0){
    url = "http://unmi.cc/tag/" + text.substring(4);
  }else if(text.indexOf("category=") == 0){
    url = "http://unmi.cc/category/" + text.substring(9);
  }else{
    url = "https://www.google.com/search?q="+encodeURIComponent(text)+"+site%3Aunmi.cc"
  }
   
  //找到当前 Tab, 并在当前 Tab 中打开相应的页面 
  chrome.tabs.getSelected(null, function(tab){
    chrome.tabs.update(tab.id, {url: url});
  });

});
{{</ highlight >}}
<br/>
4. Chrome 中引入新开发的插件<br/><br/>
在 Chrome 里，Window-&gt;Extensions, 或地址栏中输入 chrome://extensions 进入 Chrome 的扩展配置页面，选择开发模式，就可以点击 "Load unpacked extension..." 按钮，选择目录来导入刚开发的插件。Pack extension... 用来打包你的扩展。<br/><br/>
{{< bundle-image src="chrome_open_extensions-800x151.png" width="800px" >}}
加载后是这样的<br/><br/>
{{< bundle-image src="chrome_unmi_extension-800x170.png" width="800px" >}}
看到插件名, 版本，从哪个目录加载的，Chrome 为该插件生成的 ID。<br/><br/>
开发到有修改源代码，可点击 Reload 按钮重新载入，有时候会自动载入最新的代码。上面的 background page 是调试用的，比如执行代码时有什么错误能够在这个 background page 中显示出来<br/><br/>
{{< bundle-image src="chrome_extension_devtools1-800x450.png" width="800px" >}}
至此一个完整的插件宣告完成，效果就是本文第一个图片所示<br/><br/>
地址栏输入  u&gt; 空格或Tab，进入 Unmi 模式<br />
输入 play，打开页面 https://www.google.com/search?q=play+site%3Aunmi.cc<br />
输入 tag=play，打开页面 http://unmi.cc/tag/play/<br />
输入 category=scala，打开页面  http://unmi.cc/category/scala/<br/><br/>
<hr /><br/><br/>
续：我们可以创建新的 Tab 来打开页面，如<br/>
{{< highlight js >}}
chrome.browserAction.onClicked.addListener(
  function (tab){
    chrome.tabs.create({url: 'http://unmi.cc'});
  }
);
{{</ highlight >}}
<br/>
在360 网站上有翻译的 <a href="http://open.chrome.360.cn/html/dev_content_scripts.html" target="_blank" rel="noopener">Chrome 扩展开发文档</a>，官方开发文档入口 <a href="https://developer.chrome.com/extensions" target="_blank" rel="noopener">https://developer.chrome.com/extensions</a>。<br/><br/>
备：Chrome 的插件和扩展是同一个概念，本文同时使用了这两个词。
