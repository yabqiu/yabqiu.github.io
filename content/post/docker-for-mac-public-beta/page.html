---
title: Docker for Mac 公测版试用
url: /docker-for-mac-public-beta/
date: 2016-06-21T01:12:16-05:00
featured: false
draft: false
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/docker-logo.png"
categories:
  - Linux/Unix
tags: 
  - Docker
comment: true
codeMaxLines: 50
# additional
wpPostId: 7306 
wpStatus: publish
views: 534
lastmod: 2023-12-13T00:03:11-06:00
---

伴随着 2016 年 <a href="http://2016.dockercon.com/">Docker Conference</a> 的进行, Docker for Mac 和 Windows 的版本终于完全公测开始了. 之前阅读 <a href="https://blog.docker.com/2016/03/docker-for-mac-windows-beta/">Docker for Mac Windows Beta: the simple way to use Docker on your laptop</a> 里的介绍, 想要安装的必须在 <a href="https://beta.docker.com/">https://beta.docker.com/</a>  收到获准才能下载.</p>
<br/>
Docker for Mac and Windows 可能让我们在 Mac 或 Windows 下脱离 Virtual Box 虚拟机, 像在 Linux 下一样跑 Docker. 因为不存在了 Virtual Box 这一中间层, 端口重定向就变成了一件很简单的事情了. 再也不用像原来那样 <code>Localhost:80 -&gt; VirtualBox-Default:1080 -&gt; Container:80</code>, 而直接就是 <code>Localhost:80 -&gt; Container:80</code>.<br/><br/>
也不再需要用 <code>eval $(docker-machine env default)</code> 来设置 <code>DOCKER_HOST</code> 等环境变量了.<br/><br/>
目前的 Beta 版是 Version 1.12.0-rc2-beta16 (build: 9493) f615be9fb245904fbdf1aa0cad251d418c869428<br/><br/>
本人趁手的是 Mac, 所以大概讲述如何安装 Docker for Mac. 首先我们可以尽情的卸载掉已安装的 Virtual Box, Docker-Machine 和 Docker 了, 然后从 <a href="https://docs.docker.com/docker-for-mac/">https://docs.docker.com/docker-for-mac/</a> 下载 <a href="https://download.docker.com/mac/beta/Docker.dmg">Docker for Mac</a>. 它是一个 dmg 文件, 想安装普通的 Mac 应用那样拖拽到 /Applications 目录, <!--more--><br/>
{{< bundle-image docker-for-mac-install.png 720 >}}
之后可在 Launchpad 找到 Docker, 或通过 Spotlight Search 找到它并启动, 第一次启动时会要求授权进行一些初始化设置:<br/><br/>
创建如下面的执行文件链接<br/>
{{< highlight text >}}
/usr/local/bin/docker -> ~/Library/Group Containers/group.com.docker/bin/docker
/usr/local/bin/docker-machine -> ~/Library/Group Containers/group.com.docker/bin/docker-machine
/usr/local/bin/docker-compose -> ~/Library/Group Containers/group.com.docker/bin/docker-compose
/usr/local/bin/notary -> ~/Library/Group Containers/group.com.docker/bin/notary
{{</ highlight >}}
<br/>
由此可知这个 Docker dmg 安装包含有 docker, docker-machine, docker-compose, docker-diagnose, 和 notary 工具.<br/><br/>
如果之前有 docker-machine 的 <code>default</code> Vitual Box 虚拟机, 初始的时候还会询问你是否拷贝它到新的 <a href="https://github.com/mist64/xhyve/">vhyve</a> 虚拟机中, vhyve 是构建于 OS X 10.10 Yosemite 的 <a href="https://developer.apple.com/library/mac/documentation/DriversKernelHardware/Reference/Hypervisor/index.html">Hypervisor.framework</a> 之上的轻量级虚拟化技术. 而 Docker for Windows 也像 Docker for Mac 一样摒弃了 Virtual Box 而转而采用了  Hyper-V 虚拟化技术.<br/><br/>
原来用 brew 安装的 docker, docker-machine 的链接指向是下面那样子的<br/>
{{< highlight text >}}
/usr/local/bin/docker -> ../Cellar/docker/1.11.2/bin/docker
/usr/local/bin/docker-machine -> ../Cellar/docker-machine/0.7.0/bin/docker-machine
{{</ highlight >}}
<br/>
初始完之后会在系统栏上显示一个  Docker 图标<br/><br/>
{{< bundle-image docker-for-mac-tray.png 278 >}}
&nbsp;<br/><
现在开始, 使用 Docker 的命令和以前也差不多. 虽然提供了 <code>docker-machine</code> 命令, 但不再通过它来管理虚拟机了, 使用 <code>docker-machine ls</code> 什么都看不到, 不知道保留 <code>docker-machine</code> 这个命令有何用处.<br/><br/>
Docker for Mac 不再通过 TCP 端口通信, 而是用 <code>/var/tmp/com.docker.vmnetd.socket</code> 套接字文件通信<br/><br/>
我们现在来测试一下 Docker 便捷的端口重定向方式, 运行官方的 nginx 镜像, 该镜像暴露了 80 和  443 端口号, 我们可以用下面的命令直接把 Mac 的 80 映射到 nginx 容器的 80 端口上<br/>
{{< highlight sh >}}
docker -run -d -p 80:80 nginx
{{</ highlight >}}
<br/>
直接访问本地的 HTTP 80 端口就是 Docker 容器 nginx 提供的服务了<br/><br/>
{{< bundle-image docker-for-mac-ports.png 665 >}}
这个困扰我许久的麻烦事终于得到了解决, 这是坚定我开发环境下使用 Docker 的一块基石.<br/><br/>
用 <code>docker ps </code> 查看一下容器<br/>
<blockquote>
CONTAINER ID    IMAGE      COMMAND                        CREATED           STATUS             PORTS                                              NAMES<br />
e52398c5de91        nginx         "nginx -g 'daemon off"      7 minutes ago     Up 7 minutes     0.0.0.0:80-&gt;80/tcp, 443/tcp     serene_jones
</blockquote>

对于现在的 Docker for Mac, 我们可以用 <code>ps -ef|grep docker</code> 来看看它相关的进程信息<br/>
{{< highlight sh >}}
➜ ~ ps -ef|grep docker
 0 3524 1 0 11:25PM ?? 0:00.01 /Library/PrivilegedHelperTools/com.docker.vmnetd
 501 3529 3512 0 11:25PM ?? 0:00.08 /Applications/Docker.app/Contents/MacOS/com.docker.osx.hyperkit.linux -watchdog fd:0
 501 3532 3529 0 11:25PM ?? 0:00.09 /Applications/Docker.app/Contents/MacOS/com.docker.osx.hyperkit.linux -watchdog fd:0
 501 3533 3529 0 11:25PM ?? 0:04.75 com.docker.db --url=file:///Users/Yanbin/Library/Containers/com.docker.docker/Data/s40 --git /Users/Yanbin/Library/Containers/com.docker.docker/Data/database
 501 3545 3529 0 11:25PM ?? 0:00.42 com.docker.osxfs --address fd:3 --connect /Users/Yanbin/Library/Containers/com.docker.docker/Data/@connect --volume-control fd:4 --path /
 501 3546 3529 0 11:25PM ?? 0:05.18 com.docker.slirp --db /Users/Yanbin/Library/Containers/com.docker.docker/Data/s40 --socket fd:3 --port-control fd:4 --vsock-path /Users/Yanbin/Library/Containers/com.docker.docker/Data/@connect
 501 3547 3529 0 11:25PM ?? 0:02.03 com.docker.backend
 501 3548 3529 0 11:25PM ?? 0:00.78 com.docker.driver.amd64-linux -db /Users/Yanbin/Library/Containers/com.docker.docker/Data/s40 -osxfs-volume /Users/Yanbin/Library/Containers/com.docker.docker/Data/s30 -slirp /Users/Yanbin/Library/Containers/com.docker.docker/Data/s50 -vmnet /var/tmp/com.docker.vmnetd.socket -port /Users/Yanbin/Library/Containers/com.docker.docker/Data/s51 -vsock /Users/Yanbin/Library/Containers/com.docker.docker/Data -docker /Users/Yanbin/Library/Containers/com.docker.docker/Data/s60 -addr fd:3 -debug
 501 3549 3547 0 11:25PM ?? 0:00.02 /Applications/Docker.app/Contents/MacOS/com.docker.osx.hyperkit.linux
 501 3550 3548 0 11:25PM ?? 0:00.08 /Applications/Docker.app/Contents/MacOS/com.docker.driver.amd64-linux -db /Users/Yanbin/Library/Containers/com.docker.docker/Data/s40 -osxfs-volume /Users/Yanbin/Library/Containers/com.docker.docker/Data/s30 -slirp /Users/Yanbin/Library/Containers/com.docker.docker/Data/s50 -vmnet /var/tmp/com.docker.vmnetd.socket -port /Users/Yanbin/Library/Containers/com.docker.docker/Data/s51 -vsock /Users/Yanbin/Library/Containers/com.docker.docker/Data -docker /Users/Yanbin/Library/Containers/com.docker.docker/Data/s60 -addr fd:3 -debug
 501 3551 3548 0 11:25PM ?? 1:38.56 /Applications/Docker.app/Contents/MacOS/com.docker.hyperkit -A -m 2G -c 2 -u -s 0:0,hostbridge -s 31,lpc -s 2:0,virtio-vpnkit,uuid=53d7e408-aef2-4b2b-bc4c-0431075e14b7,path=/Users/Yanbin/Library/Containers/com.docker.docker/Data/s50,macfile=/Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/mac.0 -s 3,virtio-blk,file:///Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2,format=qcow -s 4,virtio-9p,path=/Users/Yanbin/Library/Containers/com.docker.docker/Data/s40,tag=db -s 5,virtio-rnd -s 6,virtio-9p,path=/Users/Yanbin/Library/Containers/com.docker.docker/Data/s51,tag=port -s 7,virtio-sock,guest_cid=3,path=/Users/Yanbin/Library/Containers/com.docker.docker/Data,guest_forwards=2376;1525 -l com1,autopty=/Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/tty,log=/Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/console-ring -f kexec,/Applications/Docker.app/Contents/Resources/moby/vmlinuz64,/Applications/Docker.app/Contents/Resources/moby/initrd.img,earlyprintk=serial console=ttyS0 com.docker.driverDir="/Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux", com.docker.database="com.docker.driver.amd64-linux" ntp=gateway -F /Users/Yanbin/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/hypervisor.pid
 501 8416 3512 0 1:06AM ?? 0:00.01 /Applications/Docker.app/Contents/Resources/bin/com.docker.frontend {"action":"vmstateevent","args":{"vmstate":"running"}}
 501 8417 8416 0 1:06AM ?? 0:00.01 /Applications/Docker.app/Contents/Resources/bin/com.docker.frontend {"action":"vmstateevent","args":{"vmstate":"running"}}
 501 5807 3788 0 12:30AM ttys004 0:00.15 docker run -it -p 80:80 nginx sh
 501 8425 8138 0 1:06AM ttys006 0:00.00 grep --color=auto --exclude-dir=.bzr --exclude-dir=CVS --exclude-dir=.git --exclude-dir=.hg --exclude-dir=.svn docker
{{</ highlight >}}
<br/>
"docker-machine" 的信息暗含在进程参数中了.<br/>
<hr /><br/>
我是卸载了原来的 docker, docker-machine 后安装的 Docker for Mac, 运行命令 <code>docker</code> 命令出现如下错误<br/>
<blockquote>
Client:<br />
 Version:      1.12.0-rc2<br />
 API version:  1.24<br />
 Go version:   go1.6.2<br />
 Git commit:   906eacd<br />
 Built:        Fri Jun 17 20:35:33 2016<br />
 OS/Arch:      darwin/amd64<br />
 Experimental: true<br />
Error response from daemon: client is newer than server (client API version: 1.24, server API version: 1.22)
</blockquote>

检查了新安装的 docker, docker-machine 都是链接到 ~/Library/Group Containers/group.com.docker/bin 下的 docker, docker-machine 的, 并不是原来 brew 安装的 docker, docker-machine.<br/><br/>
解决办法是升级 docker-machine, 需要执行命令<br/>
{{< highlight sh >}}
docker-machine upgrade
{{</ highlight >}}

<blockquote>
Waiting for SSH to be available...<br />
Detecting the provisioner...<br />
Upgrading docker...<br />
Stopping machine to do the upgrade...<br />
Upgrading machine "default"...<br />
Default Boot2Docker ISO is out-of-date, downloading the latest release...<br />
Latest release for github.com/boot2docker/boot2docker is v1.12.0-rc2<br />
Downloading /Users/yanbin/.docker/machine/cache/boot2docker.iso from https://github.com/boot2docker/boot2docker/releases/download/v1.12.0-rc2/boot2docker.iso...<br />
0%....10%....20%....30%....40%....50%....60%....70%....80%....90%....100%<br />
Copying /Users/yanbin/.docker/machine/cache/boot2docker.iso to /Users/yanbin/.docker/machine/machines/default/boot2docker.iso...<br />
Starting machine back up...<br />
(default) Check network to re-create if needed...<br />
(default) Waiting for an IP...<br />
Restarting docker...
</blockquote>

我觉得应该是安装 Docker for Mac  时选择了拷贝原来的 boot2docker 的原因, Boot2Docker ISO is out-of-date.<br/><br/>
参考: 1. <a href="https://segmentfault.com/a/1190000005106237">Docker for Mac 初体验</a><br />
          2. <a href="http://www.vpsee.com/2015/06/mac-os-x-hypervisor-xhyve-based-on-bhyve/">Mac OS X 上基于 FreeBSD/bhyve 的虚拟技术  xhyve</a><br />
          3. <a href="http://pnasrat.github.io/">Inside Docker for OS X i/ii</a>
