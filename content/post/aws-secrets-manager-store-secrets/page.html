---
title: 用 AWS Secrets Manager 存储和管理密钥
url: /aws-secrets-manager-store-secrets/
date: 2019-01-05T01:48:35-06:00
featured: false
draft: false
type: post
toc: false
# menu: main
usePageBundles: true
thumbnail: "../images/logos/aws-logo.png"
categories:
  - AWS
tags: 
  - AWS
  - Cloud
comment: true
codeMaxLines: 50
# additional
wpPostId: 9257 
wpStatus: publish
views: 3129
lastmod: 2019-01-05T18:17:17-06:00
---

<p>目前我们在 AWS 上把密钥，API Key  等信息是存储在  AWS Systems Manager 的 Parameter Store 中，它只提供了用 KMS Key 加密存储字符串的功能，最大字符串大小是 4096 个字符，它是免费的。</p>

<p>最近发现 AWS 上有一个新的服务 AWS Secrets Manager(2018 年 4 月发布的)，听起来用它来存储密钥信息更高大上些。它同样提供了用 KMS Key 加密存储字符串的功能，字符串最大也是 4096 个字符。从 AWS Web 控制台上看可配置用 Key/Value 的形式，其实本质也是存储为一个 JSON 字符串。</p>

<p>Secrets Manager 与 Parameter Store 更多的功能是能与 RDS 集成 -- 选择数据库收集数据库的配置信息(主机名，端口，实例等), 还有就是可配置定期更新密钥，这对一个安全的系统定期改密码很重要。对于定期更新密钥的未作深入研究，AWS Secrets Manager 本身知道如何轮换 RDS 数据库的密钥，其他的需要一个 Lambda 来支持。<!--more--></p>

<p>Secrets Manger 相比于 Parameter Store 除了可定期轮换密码，再就是审计功能，其他的话没有太大的差别。对了 Secrets Manager 要钱的，一个密钥一个月 $0.40， 每 10,000 次 API 调用收 $0.05。如果用 Parameter Store, 结合 CloudWatch 和 Lambda 也能实现定期轮换密码。</p>

<p>为了方便 Parameter Store 过度到 Secrets Manager，我们还能用 Parameter Store(SSM) 的 API 来获得  Secrets Manager 中配置的值。支持 <code>GetParameter</code> 和 <code>GetParameters</code> 操作，需要加上特定的 Key 前缀来指明获取的是 Secrets Manager 中的密钥，如 Key: <code>/aws/reference/secretsmanager/&lt;secret_ID_in_Secrets_Manager&gt;</code>。</p>

<h3>Secret 的创建</h3>
<p>创建 Secret 时可以选择某个 RDS 实例，填入用户名，密码，选择一个用于加密的 KMS key，那么 Secrets Manager 生成一个包含类似以下信息的字符串密钥</p>

{{< highlight json >}}
{
  "username": "yanbin",
  "password": "password",
  "engine": "postgres",
  "host": "my_db.cco3cswdko89.us-east-1.rds.amazonaws.com",
  "port": 5432,
  "dbInstanceIdentifier": "my_db"
}
{{</ highlight >}}

<p>后台可展示为 Secret key/value 形式，便于查看与编辑。</p>

<p>或者创建时可以手工以 Secret key/value 的形式输入或直接编辑 Plaintext 内容。注意 Plaintext 中编辑时并不要求一定要符合 JSON 格式，可为任意的字符串，只是会造成切换回 Secret key/value 标签后无法显示。这个不要紧，反正后面的 API 获取到的也是一个字符串，必要时自行解析字符串为 JSON 对象。</p>

<p>输入其他的基本信息，Secret name, 描述信息，Tag 等。</p>

<h3>获取 Secret</h3>
<p>在 AWS 控制台打开每个 Secret 下方要获取密钥的示例代码，包含 Java, Javascript, C#, Python3, Ruby 和 Go 语言的。下面以 Python 3 为例，只保留了关键代码</p>

{{< highlight python >}}
import boto3
import json

session = boto3.Session(...)


def get_secret():
    secret_name = "qa/postgres/my_db"
    client = session.client('secretsmanager')
    get_secret_value_response = client.get_secret_value(SecretId=secret_name)
    return get_secret_value_response['SecretString']


if __name__ == '__main__':

    for i in range(20):
        secret_json = json.loads(get_secret())
        print(secret_json['username'])
{{</ highlight >}}

<p>上面代码得到前面数据库配置的用户名，假设 Secret key 是 <code>qa/postgres/my_db</code>。如果配置的只是一个 Plaintext，那么取到的 <code>get_secrete()</code> 就是我们想要的。</p>

<h3>读取 Secret 的 IAM 权限</h3>
<p>上面读取 Secret 的用户需要有两个相应的权限才能正确执行</p>

<ol>
	<li>对 Secret key <code>qa/postgres/my_db</code> 的 <code>secretsmanager:GetSecretValue</code> 权限</li>
	<li>对所用来加密的 KMS key 的 <code>kms:Decrypt</code> 权限</li>
</ol>

<p>少了第一个权限会得到如下类似错误：</p>

<blockquote>
<p>botocore.exceptions.ClientError: An error occurred (AccessDeniedException) when calling the GetSecretValue operation: User: arn:aws:iam::1234567890:user/program_user is not authorized to perform: secretsmanager:GetSecretValue on resource: arn:aws:secretsmanager:us-east-1:1234567890:secret:qa/postgres/my_db-DaFxju</p>
</blockquote>

<p>如果没有第二个权限会得到如下类似的错误：</p>

<blockquote>
<p>botocore.exceptions.ClientError: An error occurred (AccessDeniedException) when calling the GetSecretValue operation: Access to KMS is not allowed</p>
</blockquote>

<p>通过 Parameter Store API 来读取 Secret</p>

{{< highlight python >}}
def get_secret():
    secret_name = "qa/postgres/my_db"
    client = session.client('ssm')
    get_parameter_response = client.get_parameter(
        Name=f'/aws/reference/secretsmanager/{secret_name}',
        WithDecryption=True
    )
    return get_parameter_response['Parameter']['Value']
{{</ highlight >}}

<p>这时候的权限要求就会有些奇怪了。需要的也是同上面完全一样的两个  <code>secretsmanager:GetSecretValue</code> 和 <code>kms:Decrypt</code> 。</p>

<p>虽然是在用 <code>ssm</code> 的 <code>getParameter()</code> 方法，实际上是不需要 <code>ssm:GetParameter</code> 权限的，所以底层上对 <code>ssm.get_parameter()</code> 的调用实际上委派给了 <code>secretsmanager.get_secret_value()</code> 操作。如果真要给个 <code>ssm:GetParameter</code> 权限，资源上也无法指定一个 secretesmanager 的资源啊。</p>

<p>链接：</p>

<ol>
	<li><a href="https://itnext.io/keeping-your-secrets-safe-with-aws-secrets-manager-55e8e186abef">Keeping Secrets with AWS Secrets Manager</a></li>
</ol>
